<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos DECE - UEPDC</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <!-- Cargar Tailwind con defer para no bloquear -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar EmailJS con defer -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        /* PANTALLA DE CARGA */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #3b82f6 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-in-left { animation: slideInLeft 0.6s ease-out; }
        .slide-in-right { animation: slideInRight 0.6s ease-out; }
        .scale-in { animation: scaleIn 0.4s ease-out; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #3b82f6 100%);
        }
        
        .gradient-bg-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-bg-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-bg-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-modern:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-modern span {
            position: relative;
            z-index: 1;
        }
        
        .smooth-update {
            transition: all 0.3s ease;
        }
        
        .logo-institucional {
            width: 70px;
            height: 70px;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.2));
        }
        
        .badge-en-proceso {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }
        
        .select-modern {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
        }

        /* OPTIMIZACIONES RESPONSIVAS */
        .control-disponible-card {
            padding: 1.5rem;
            min-height: auto;
        }

        .control-disponible-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        .control-disponible-title {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .control-disponible-text {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .control-disponible-btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        .control-stats-card {
            padding: 1.25rem;
        }

        .control-stats-number {
            font-size: 2.5rem;
            margin-bottom: 0.25rem;
        }

        .control-stats-label {
            font-size: 0.875rem;
        }

        /* Ajustes para pantallas grandes */
        @media (min-width: 1400px) {
            .control-disponible-card {
                padding: 2rem;
            }
            
            .control-disponible-icon {
                font-size: 3.5rem;
            }
            
            .control-disponible-title {
                font-size: 2rem;
            }
        }

        /* Ajustes para pantallas muy grandes */
        @media (min-width: 1920px) {
            .control-disponible-card {
                padding: 2.5rem;
            }
            
            .control-stats-card {
                padding: 1.5rem;
            }
        }

        /* Ajustes para m√≥viles */
        @media (max-width: 768px) {
            .control-disponible-card {
                padding: 1.25rem;
            }
            
            .control-disponible-icon {
                font-size: 2.5rem;
            }
            
            .control-disponible-title {
                font-size: 1.5rem;
            }
            
            .control-stats-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- PANTALLA DE CARGA -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando Sistema DECE...</div>
    </div>

    <!-- APLICACI√ìN -->
    <div id="app"></div>

    <script>
        console.log('üöÄ Iniciando carga del sistema...');
        
        
        // BASE DE DATOS DE ESTUDIANTES
        let ESTUDIANTES_BD = {};
        
        // Cargar base de datos de estudiantes - OPTIMIZADO
        async function cargarEstudiantes() {
            try {
                const response = await fetch('estudiantes_uepdc.json');
                if (!response.ok) throw new Error('No se pudo cargar la base de datos');
                ESTUDIANTES_BD = await response.json();
                console.log('‚úÖ Base de datos de estudiantes cargada:', Object.keys(ESTUDIANTES_BD).length, 'cursos');
                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar estudiantes:', error);
                // No mostrar notificaci√≥n para no bloquear la carga
                return false;
            }
        }
        
        // Buscar estudiante por email
        function buscarEstudiantePorEmail(email) {
            for (const curso in ESTUDIANTES_BD) {
                const estudiante = ESTUDIANTES_BD[curso].find(e => 
                    e['Email estudiante'].toLowerCase() === email.toLowerCase()
                );
                if (estudiante) {
                    return {
                        nombre: estudiante['Nombre completo estudiante'],
                        email: estudiante['Email estudiante'],
                        curso: curso
                    };
                }
            }
            return null;
        }
        
        // ========== CONFIGURACI√ìN DE EMAILJS - ACTUALIZADA ==========
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: 'RtA5YFyTxrNjrb_CX',
            SERVICE_ID: 'service_83qp86c',
            TEMPLATE_ACEPTADO_UNIFICADO: 'template_oozm9r',  // ‚úÖ Template √öNICO de aceptaci√≥n
            TEMPLATE_RECHAZO_UNIFICADO: 'template_x6r7fzo'   // ‚úÖ Template √öNICO de rechazo
        };
        
        // Variable para controlar si EmailJS est√° listo
        let emailJSReady = false;
        
        // Inicializar EmailJS - OPTIMIZADO (se ejecuta cuando el DOM est√° listo)
        function initEmailJS() {
            try {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
                    emailJSReady = true;
                    console.log('‚úÖ EmailJS inicializado correctamente');
                } else {
                    console.warn('‚ö†Ô∏è EmailJS a√∫n no est√° disponible, reintentando...');
                    setTimeout(initEmailJS, 500);
                }
            } catch (error) {
                console.error('‚ùå Error al inicializar EmailJS:', error);
            }
        }
        
        // ========== FUNCI√ìN UNIFICADA: EMAIL DE ACEPTACI√ìN ==========
        async function enviarEmailAceptacion(turno) {
            console.log('üìß ENVIANDO EMAIL DE ACEPTACI√ìN');
            
            if (!emailJSReady || typeof emailjs === 'undefined') {
                console.warn('‚ö†Ô∏è EmailJS no est√° disponible');
                return false;
            }
            
            if (!turno || typeof turno !== 'object') {
                console.error('‚ùå Turno no v√°lido');
                return false;
            }
            
            let emailEstudiante = turno.email_estudiante || turno.correo_estudiante || turno.email;
            
            if (!emailEstudiante) {
                console.error('‚ùå Email es NULL o undefined');
                return false;
            }
            
            const emailEstudianteLimpio = String(emailEstudiante).trim();
            const emailProfesor = String(turno.email_profesor || '').trim();
            const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!regexEmail.test(emailEstudianteLimpio)) {
                console.error('‚ùå Email del estudiante con formato inv√°lido:', emailEstudianteLimpio);
                return false;
            }
            
            try {
                const fechaSolicitud = turno.created_at 
                    ? new Date(turno.created_at).toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })
                    : 'No disponible';
                
                const horaSolicitud = turno.created_at
                    ? new Date(turno.created_at).toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })
                    : 'No disponible';
                
                // Template params - funciona para ambos casos
                const templateParams = {
                    to_email: emailEstudianteLimpio,
                    reply_to: emailEstudianteLimpio,
                    to_name: String(turno.nombre || 'Estudiante'),
                    student_name: String(turno.nombre || 'Estudiante'),
                    turno_numero: String(turno.numero_turno || turno.id || 'N/A'),
                    fecha_solicitud: String(fechaSolicitud),
                    hora_solicitud: String(horaSolicitud),
                    hora_atencion: String(turno.hora_atencion_programada || 'Por confirmar'),
                    motivo: String(turno.motivo || 'No especificado'),
                    curso: String(turno.curso || 'No especificado'),
                    cedula: String(turno.cedula || 'No especificada'),
                    // Campos del profesor (solo se mostrar√°n si existen)
                    teacher_name: String(turno.nombre_profesor || ''),
                    teacher_email: emailProfesor
                };
                
                // Enviar al estudiante
                await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ACEPTADO_UNIFICADO,
                    templateParams
                );
                console.log('‚úÖ Email de aceptaci√≥n enviado al estudiante');
                
                // Si fue solicitado por profesor, tambi√©n enviar al profesor
                if (turno.solicitado_por === 'profesor' && regexEmail.test(emailProfesor)) {
                    templateParams.to_email = emailProfesor;
                    templateParams.to_name = turno.nombre_profesor;
                    
                    await emailjs.send(
                        EMAILJS_CONFIG.SERVICE_ID,
                        EMAILJS_CONFIG.TEMPLATE_ACEPTADO_UNIFICADO,
                        templateParams
                    );
                    console.log('‚úÖ Email de aceptaci√≥n enviado al profesor');
                    showNotification(`üìß Notificaciones de aceptaci√≥n enviadas al estudiante y profesor`, 'success');
                } else {
                    showNotification(`üìß Email enviado a ${emailEstudianteLimpio}`, 'success');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå ERROR AL ENVIAR EMAIL DE ACEPTACI√ìN:', error);
                return false;
            }
        }
        
        // ========== FUNCI√ìN UNIFICADA: EMAIL DE RECHAZO ==========
        async function enviarEmailRechazo(turno, motivoRechazo) {
            console.log('üìß ENVIANDO EMAIL DE RECHAZO');
            
            if (!emailJSReady || typeof emailjs === 'undefined') {
                console.warn('‚ö†Ô∏è EmailJS no est√° disponible');
                return false;
            }
            
            if (!turno || !turno.email_estudiante) {
                console.error('‚ùå Datos del turno incompletos');
                return false;
            }
            
            const emailEstudiante = String(turno.email_estudiante || '').trim();
            const emailProfesor = String(turno.email_profesor || '').trim();
            const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!regexEmail.test(emailEstudiante)) {
                console.error('‚ùå Email del estudiante inv√°lido');
                return false;
            }
            
            try {
                const fechaSolicitud = turno.created_at 
                    ? new Date(turno.created_at).toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })
                    : 'No disponible';
                
                // Template params - funciona para ambos casos
                const templateParams = {
                    to_email: emailEstudiante,
                    reply_to: emailEstudiante,
                    to_name: String(turno.nombre || 'Estudiante'),
                    student_name: String(turno.nombre || 'Estudiante'),
                    turno_numero: String(turno.numero_turno || turno.id || 'N/A'),
                    fecha_solicitud: fechaSolicitud,
                    motivo_turno: String(turno.motivo || 'No especificado'),
                    motivo_rechazo: String(motivoRechazo || 'No especificado'),
                    curso: String(turno.curso || 'No especificado'),
                    // Campos del profesor (solo se mostrar√°n si existen)
                    teacher_name: String(turno.nombre_profesor || ''),
                    teacher_email: emailProfesor
                };
                
                // Enviar al estudiante
                await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_RECHAZO_UNIFICADO,
                    templateParams
                );
                console.log('‚úÖ Email de rechazo enviado al estudiante');
                
                // Si fue solicitado por profesor, tambi√©n enviar al profesor
                if (turno.solicitado_por === 'profesor' && regexEmail.test(emailProfesor)) {
                    templateParams.to_email = emailProfesor;
                    templateParams.to_name = turno.nombre_profesor;
                    
                    await emailjs.send(
                        EMAILJS_CONFIG.SERVICE_ID,
                        EMAILJS_CONFIG.TEMPLATE_RECHAZO_UNIFICADO,
                        templateParams
                    );
                    console.log('‚úÖ Email de rechazo enviado al profesor');
                    showNotification(`üìß Notificaciones de rechazo enviadas al estudiante y profesor`, 'info');
                } else {
                    showNotification(`üìß Notificaci√≥n de rechazo enviada`, 'info');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå ERROR AL ENVIAR EMAIL DE RECHAZO:', error);
                return false;
            }
        }
        
        // CONFIGURACI√ìN DE SUPABASE
        const SUPABASE_URL = 'https://hynubiwdlpkfzqgzahlp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5bnViaXdkbHBrZnpxZ3phaGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDM1MzYsImV4cCI6MjA3OTE3OTUzNn0.xbiu1OVD9I8V_NYj0gem1zK5wICW_cXrxIoRRwQFbAg';

        const DECE_CREDENTIALS = {
            email: 'deceuepdcdece@uepdc.edu.ec',
            password: 'geraldmontoya'
        };

        // UTILIDADES DE HORA - ECUADOR
        const HoraUtils = {
            getHoraEcuador() {
                const ahora = new Date();
                try {
                    const opciones = { 
                        timeZone: 'America/Guayaquil', 
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };
                    
                    const formateador = new Intl.DateTimeFormat('es-EC', opciones);
                    const partes = formateador.formatToParts(ahora);
                    
                    const valores = {};
                    partes.forEach(parte => {
                        if (parte.type !== 'literal') {
                            valores[parte.type] = parte.value;
                        }
                    });
                    
                    const horaEcuador = new Date(
                        parseInt(valores.year),
                        parseInt(valores.month) - 1,
                        parseInt(valores.day),
                        parseInt(valores.hour),
                        parseInt(valores.minute),
                        parseInt(valores.second)
                    );
                    
                    return horaEcuador;
                    
                } catch (error) {
                    const utc = ahora.getTime() + (ahora.getTimezoneOffset() * 60000);
                    return new Date(utc + (-5 * 3600000));
                }
            },
            
            horaAMinutos(hora) {
                const [h, m] = hora.split(':').map(Number);
                return h * 60 + m;
            },
            
            minutosAHora(minutos) {
                const h = Math.floor(minutos / 60);
                const m = minutos % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            },
            
            agregarMinutos(hora, minutos) {
                const minutosActual = this.horaAMinutos(hora);
                const nuevosMinutos = minutosActual + minutos;
                return this.minutosAHora(nuevosMinutos);
            },
            
            formatearAMPM(hora) {
                const [h, m] = hora.split(':').map(Number);
                const ampm = h >= 12 ? 'p.m' : 'a.m';
                const hora12 = h % 12 || 12;
                return `${hora12}:${m.toString().padStart(2, '0')} ${ampm}`;
            },
            
            generarRango(horaInicio) {
                const horaFin = this.agregarMinutos(horaInicio, 40);
                return `${this.formatearAMPM(horaInicio)} a ${this.formatearAMPM(horaFin)}`;
            },
            
            citaYaTermino(horaInicio) {
                const horaEcuador = this.getHoraEcuador();
                const horaActualMinutos = horaEcuador.getHours() * 60 + horaEcuador.getMinutes();
                const horaInicioMinutos = this.horaAMinutos(horaInicio);
                const horaFinMinutos = horaInicioMinutos + 40;
                return horaActualMinutos >= horaFinMinutos;
            },
            
            citaEnProceso(horaInicio) {
                const horaEcuador = this.getHoraEcuador();
                const horaActualMinutos = horaEcuador.getHours() * 60 + horaEcuador.getMinutes();
                const horaInicioMinutos = this.horaAMinutos(horaInicio);
                const horaFinMinutos = horaInicioMinutos + 40;
                return horaActualMinutos >= horaInicioMinutos && horaActualMinutos < horaFinMinutos;
            },
            
            extraerHoraInicio(rangoHora) {
                const match = rangoHora.match(/(\d{1,2}):(\d{2})\s*(a\.m|p\.m)/);
                if (!match) return null;
                
                let hora = parseInt(match[1]);
                const minutos = match[2];
                const periodo = match[3];
                
                if (periodo === 'p.m' && hora !== 12) {
                    hora += 12;
                } else if (periodo === 'a.m' && hora === 12) {
                    hora = 0;
                }
                
                return `${hora.toString().padStart(2, '0')}:${minutos}`;
            }
        };

        // ESTADO DE LA APLICACI√ìN
        let state = {
            vista: 'login',
            tipoUsuario: null,
            usuarioActual: null,
            configurado: false,
            estadoDECE: { id: 1, disponible: true },
            turnos: [],
            miTurno: null,
            estadisticas: {
                totalHoy: 0,
                pendientes: 0,
                aceptados: 0,
                enProceso: 0,
                atendidos: 0,
                rechazados: 0,
                no_asistio: 0
            },
            filtroTurnos: 'todos',
            busqueda: '',
            historialEstudiante: []
        };

        // CLIENTE SUPABASE - OPTIMIZADO
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}`, {
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    });
                    const data = await response.json();
                    return { data, error: response.ok ? null : data };
                },
                insert: async (values) => {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(values)
                    });
                    const data = await response.json();
                    return { data, error: response.ok ? null : data };
                },
                update: (values) => ({
                    eq: async (column, value) => {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(values)
                        });
                        const data = await response.json();
                        return { data, error: response.ok ? null : data };
                    }
                }),
                delete: () => ({
                    eq: async (column, value) => {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                            method: 'DELETE',
                            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                        });
                        return { error: response.ok ? null : await response.json() };
                    }
                })
            })
        };

        // FUNCIONES DE DATOS
        async function verificarYActualizarEstadosTurnos(turnos) {
            for (const turno of turnos) {
                if (turno.estado === 'aceptado' && turno.hora_atencion_programada) {
                    const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                    
                    if (!horaInicio) continue;
                    
                    if (HoraUtils.citaYaTermino(horaInicio)) {
                        console.log(`‚úÖ Auto-marcando turno ${turno.id} como ATENDIDO (cita terminada)`);
                        await supabase.from('turnos').update({ 
                            estado: 'atendido',
                            hora_atencion: new Date().toISOString()
                        }).eq('id', turno.id);
                    }
                }
            }
        }
        
        async function cargarDatos() {
            try {
                const { data: config } = await supabase.from('configuracion').select('*');
                if (config && config.length > 0) {
                    const nuevoEstado = config[0].disponible;
                    if (state.estadoDECE.disponible !== nuevoEstado) {
                        state.estadoDECE = config[0];
                        actualizarEstadoDECEUI();
                    }
                }
                
                const { data: turnosData } = await supabase.from('turnos').select('*');
                if (turnosData) {
                    await verificarYActualizarEstadosTurnos(turnosData);
                    
                    const { data: turnosActualizados } = await supabase.from('turnos').select('*');
                    const turnosOrdenados = turnosActualizados.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    state.turnos = turnosOrdenados;
                    calcularEstadisticas();
                    
                    if (state.vista === 'dece') {
                        actualizarEstadisticasUI();
                        actualizarListaTurnosUI();
                    }
                }
                
                const miTurnoId = localStorage.getItem('miTurnoId');
                if (miTurnoId && turnosData) {
                    const turnoActualizado = state.turnos.find(t => t.id === parseInt(miTurnoId));
                    if (turnoActualizado) {
                        state.miTurno = turnoActualizado;
                        
                        if (state.vista === 'estudiante' && state.miTurno) {
                            actualizarMiTurnoUI();
                        }
                    } else {
                        state.miTurno = null;
                        localStorage.removeItem('miTurnoId');
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        function calcularEstadisticas() {
            const hoy = new Date().toLocaleDateString('es-ES');
            const turnosHoy = state.turnos.filter(t => 
                new Date(t.created_at).toLocaleDateString('es-ES') === hoy
            );
            
            let enProceso = 0;
            state.turnos.forEach(t => {
                if (t.estado === 'aceptado' && t.hora_atencion_programada) {
                    const horaInicio = HoraUtils.extraerHoraInicio(t.hora_atencion_programada);
                    if (horaInicio && HoraUtils.citaEnProceso(horaInicio)) {
                        enProceso++;
                    }
                }
            });
            
            state.estadisticas = {
                totalHoy: turnosHoy.length,
                pendientes: state.turnos.filter(t => t.estado === 'pendiente').length,
                aceptados: state.turnos.filter(t => t.estado === 'aceptado').length,
                enProceso: enProceso,
                atendidos: state.turnos.filter(t => t.estado === 'atendido').length,
                rechazados: state.turnos.filter(t => t.estado === 'rechazado').length,
                no_asistio: state.turnos.filter(t => t.estado === 'no_asistio').length
            };
        }

        async function verificarConfiguracion() {
            try {
                const { data, error } = await supabase.from('configuracion').select('*');
                if (!error) {
                    state.configurado = true;
                    if (data && data.length > 0) {
                        state.estadoDECE = data[0];
                    }
                    await cargarDatos();
                }
            } catch (err) {
                state.configurado = false;
            }
        }

        // FUNCIONES DE ACTUALIZACI√ìN UI
        function actualizarEstadoDECEUI() {
            const elemento = document.getElementById('estadoDECE');
            if (!elemento) return;
            
            const disponible = state.estadoDECE.disponible;
            elemento.innerHTML = `
                <div class="${disponible ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} p-10 rounded-2xl text-center text-white shadow-xl smooth-update">
                    <div class="text-7xl mb-4">${disponible ? '‚úÖ' : '‚ùå'}</div>
                    <div class="text-4xl font-black mb-3">
                        ${disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                    </div>
                    <p class="text-xl opacity-90">${disponible ? '¬°Puedes solicitar un turno ahora!' : 'El DECE no est√° recibiendo solicitudes'}</p>
                </div>
            `;
        }

        function actualizarEstadisticasUI() {
            const container = document.getElementById('estadisticasContainer');
            if (!container) return;
            
            const stats = state.estadisticas;
            container.innerHTML = `
                <div class="bg-blue-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.totalHoy}</div>
                    <div class="control-stats-label opacity-90">Hoy</div>
                </div>
                <div class="bg-yellow-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.pendientes}</div>
                    <div class="control-stats-label opacity-90">Pendientes</div>
                </div>
                <div class="bg-green-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.aceptados}</div>
                    <div class="control-stats-label opacity-90">Aceptados</div>
                </div>
                ${stats.enProceso > 0 ? `
                <div class="bg-orange-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.enProceso}</div>
                    <div class="control-stats-label opacity-90">En Proceso</div>
                </div>
                ` : ''}
                <div class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.atendidos}</div>
                    <div class="control-stats-label opacity-90">Atendidos</div>
                </div>
                <div class="bg-red-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.rechazados}</div>
                    <div class="control-stats-label opacity-90">Rechazados</div>
                </div>
                <div class="bg-gray-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.no_asistio}</div>
                    <div class="control-stats-label opacity-90">No Asisti√≥</div>
                </div>
            `;
        }

        function actualizarListaTurnosUI() {
            const container = document.getElementById('listaTurnos');
            if (!container) return;
            
            let turnosFiltrados = state.turnos;
            
            if (state.filtroTurnos !== 'todos') {
                turnosFiltrados = state.turnos.filter(t => t.estado === state.filtroTurnos);
            }
            
            if (state.busqueda) {
                const busquedaLower = state.busqueda.toLowerCase();
                turnosFiltrados = turnosFiltrados.filter(t => 
                    t.nombre.toLowerCase().includes(busquedaLower) ||
                    t.curso.toLowerCase().includes(busquedaLower) ||
                    t.motivo.toLowerCase().includes(busquedaLower)
                );
            }
            
            container.innerHTML = turnosFiltrados.length > 0 
                ? turnosFiltrados.map(renderTurnoCard).join('') 
                : renderSinTurnos();
        }

        function actualizarMiTurnoUI() {
            const container = document.getElementById('miTurnoContent');
            if (!container || !state.miTurno) return;
            
            container.innerHTML = renderMiTurnoContent();
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-5 right-5 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 font-bold text-lg`;
            notification.textContent = message;
            notification.style.animation = 'slideInRight 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // AUTENTICACI√ìN
        async function loginEstudiante(email, password) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&password=eq.${encodeURIComponent(password)}&select=*`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                
                const usuarios = await response.json();
                
                if (usuarios && usuarios.length > 0) {
                    const usuario = usuarios[0];
                    state.usuarioActual = usuario;
                    state.tipoUsuario = 'estudiante';
                    state.vista = 'estudiante';
                    localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario }));
                    
                    await cargarDatos();
                    
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId && state.turnos.length > 0) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => 
                        t.email_estudiante === usuario.email
                    );
                    
                    render();
                    showNotification(`¬°Bienvenido/a ${usuario.nombre}!`, 'success');
                    return true;
                }
                
                const usuariosLocal = JSON.parse(localStorage.getItem('usuarios_estudiantes') || '[]');
                const usuarioLocal = usuariosLocal.find(u => u.email === email && u.password === password);
                
                if (usuarioLocal) {
                    state.usuarioActual = usuarioLocal;
                    state.tipoUsuario = 'estudiante';
                    state.vista = 'estudiante';
                    localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario: usuarioLocal }));
                    
                    await cargarDatos();
                    
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId && state.turnos.length > 0) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => 
                        t.email_estudiante === usuarioLocal.email
                    );
                    
                    render();
                    showNotification(`¬°Bienvenido/a ${usuarioLocal.nombre}!`, 'success');
                    return true;
                }
                
                showNotification('Credenciales incorrectas', 'error');
                return false;
            } catch (err) {
                console.error('‚ùå Error en loginEstudiante:', err);
                showNotification('Error al iniciar sesi√≥n', 'error');
                return false;
            }
        }

        async function registrarEstudiante(nombre, email, cedula, cursoCompleto, password) {
            try {
                if (!email.endsWith('@est.uepdc.edu.ec')) {
                    showNotification('Debes usar tu correo institucional (@est.uepdc.edu.ec)', 'error');
                    return false;
                }
                
                const responseEmail = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=email`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                const emailData = await responseEmail.json();
                
                if (emailData && emailData.length > 0) {
                    showNotification('El correo ya est√° registrado', 'error');
                    return false;
                }
                
                const responseCedula = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?cedula=eq.${encodeURIComponent(cedula)}&select=cedula`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                const cedulaData = await responseCedula.json();
                
                if (cedulaData && cedulaData.length > 0) {
                    showNotification('La c√©dula ya est√° registrada', 'error');
                    return false;
                }
                
                const nuevoUsuario = { nombre, email, cedula, curso: cursoCompleto, password };
                const { data, error } = await supabase
                    .from('usuarios_estudiantes')
                    .insert([nuevoUsuario]);
                
                if (error) {
                    const usuarios = JSON.parse(localStorage.getItem('usuarios_estudiantes') || '[]');
                    
                    if (usuarios.find(u => u.email === email)) {
                        showNotification('El correo ya est√° registrado', 'error');
                        return false;
                    }
                    if (usuarios.find(u => u.cedula === cedula)) {
                        showNotification('La c√©dula ya est√° registrada', 'error');
                        return false;
                    }
                    
                    usuarios.push(nuevoUsuario);
                    localStorage.setItem('usuarios_estudiantes', JSON.stringify(usuarios));
                    showNotification('‚ö†Ô∏è Registrado localmente (sin conexi√≥n a BD)', 'warning');
                } else {
                    showNotification(`¬°Registro exitoso! Bienvenido/a ${nombre}`, 'success');
                }
                
                state.usuarioActual = nuevoUsuario;
                state.tipoUsuario = 'estudiante';
                state.vista = 'estudiante';
                localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario: nuevoUsuario }));
                
                await cargarDatos();
                render();
                return true;
            } catch (err) {
                console.error('‚ùå Error en registrarEstudiante:', err);
                showNotification('Error: ' + err.message, 'error');
                return false;
            }
        }

        function loginDECE(email, password) {
            if (email === DECE_CREDENTIALS.email && password === DECE_CREDENTIALS.password) {
                state.tipoUsuario = 'dece';
                state.vista = 'dece';
                localStorage.setItem('sesion', JSON.stringify({ tipo: 'dece' }));
                
                cargarDatos().then(() => {
                    render();
                    showNotification('Sesi√≥n DECE iniciada correctamente', 'success');
                });
                return true;
            }
            return false;
        }


        
        async function loginProfesor(email) {
            if (!email.endsWith('@uepdc.edu.ec') || email.endsWith('@est.uepdc.edu.ec')) {
                showNotification('Debes usar tu correo institucional de profesor (@uepdc.edu.ec)', 'error');
                return false;
            }
            
            const nombreEmail = email.split('@')[0].replace(/\./g, ' ');
            const nombre = nombreEmail.split(' ').map(p => 
                p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()
            ).join(' ');
            
            state.usuarioActual = { email, nombre };
            state.tipoUsuario = 'profesor';
            state.vista = 'profesor';
            localStorage.setItem('sesion', JSON.stringify({ tipo: 'profesor', usuario: { email, nombre } }));
            
            await cargarDatos();
            render();
            showNotification(`¬°Bienvenido/a Profesor/a ${nombre}!`, 'success');
            return true;
        }

        function cerrarSesion() {
            state.usuarioActual = null;
            state.tipoUsuario = null;
            state.vista = 'login';
            state.miTurno = null;
            state.historialEstudiante = [];
            localStorage.removeItem('sesion');
            localStorage.removeItem('miTurnoId');
            render();
            showNotification('Sesi√≥n cerrada', 'info');
        }

        // GESTI√ìN DE TURNOS
        async function registrarTurno(form) {
            if (!state.estadoDECE.disponible) {
                showNotification('El DECE no est√° disponible en este momento', 'warning');
                return false;
            }
            
            try {
                const emailEstudiante = state.usuarioActual?.email;
                
                if (!emailEstudiante || emailEstudiante.trim() === '') {
                    showNotification('Error: No se pudo obtener tu email', 'error');
                    return false;
                }
                
                const nuevoTurno = {
                    nombre: form.nombre,
                    cedula: form.cedula,
                    curso: form.curso,
                    motivo: form.motivo,
                    situacion: form.situacion || '',
                    estado: 'pendiente',
                    numero_turno: state.turnos.length + 1,
                    email_estudiante: emailEstudiante.trim()
                };
                
                const { data, error } = await supabase.from('turnos').insert([nuevoTurno]);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const turnoGuardado = data[0];
                    localStorage.setItem('miTurnoId', turnoGuardado.id);
                    await cargarDatos();
                    
                    const turnoCreado = state.turnos.find(t => t.id === turnoGuardado.id);
                    if (turnoCreado) state.miTurno = turnoCreado;
                    
                    showNotification('¬°Turno registrado exitosamente! üéâ', 'success');
                    render();
                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al registrar el turno: ' + error.message, 'error');
                return false;
            }
        }


        
        async function registrarTurnoProfesor(turnoData) {
            if (!state.estadoDECE.disponible) {
                showNotification('El DECE no est√° disponible en este momento', 'warning');
                return false;
            }
            
            try {
                const nuevoTurno = {
                    nombre: turnoData.nombre,
                    cedula: turnoData.cedula,
                    curso: turnoData.curso,
                    motivo: turnoData.motivo,
                    situacion: turnoData.situacion,
                    estado: 'pendiente',
                    numero_turno: state.turnos.length + 1,
                    email_estudiante: turnoData.email_estudiante,
                    solicitado_por: turnoData.solicitado_por,
                    email_profesor: turnoData.email_profesor,
                    nombre_profesor: turnoData.nombre_profesor
                };
                
                const { data, error } = await supabase.from('turnos').insert([nuevoTurno]);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    await cargarDatos();
                    showNotification(`¬°Turno registrado exitosamente para ${turnoData.nombre}! üéâ`, 'success');
                    
                    document.getElementById('formTurnoProfesor').reset();
                    document.getElementById('estudianteSelect').disabled = true;
                    document.getElementById('estudianteInfo').classList.add('hidden');
                    
                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
                return false;
            }
        }

        async function cambiarDisponibilidad() {
            try {
                const nuevoEstado = !state.estadoDECE.disponible;
                const { error } = await supabase.from('configuracion').update({ 
                    disponible: nuevoEstado 
                }).eq('id', state.estadoDECE.id);
                
                if (error) throw error;
                
                state.estadoDECE.disponible = nuevoEstado;
                showNotification(nuevoEstado ? 'Sistema activado ‚úÖ' : 'Sistema pausado ‚è∏Ô∏è', 'info');
                
                render();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // ========== FUNCI√ìN ACTUALIZADA: ENV√çA EMAIL DE RECHAZO ==========
        async function actualizarEstadoTurno(turnoId, nuevoEstado, motivoRechazo = null, horaProgramada = null, notaDECE = null) {
            try {
                const actualizado = { estado: nuevoEstado };
                if (motivoRechazo) actualizado.motivo_rechazo = motivoRechazo;
                if (horaProgramada) actualizado.hora_atencion_programada = horaProgramada;
                if (notaDECE) actualizado.nota_dece = notaDECE;
                if (nuevoEstado === 'atendido' || nuevoEstado === 'no_asistio') {
                    actualizado.hora_atencion = new Date().toISOString();
                }
                
                const { error } = await supabase.from('turnos').update(actualizado).eq('id', turnoId);
                if (error) throw error;
                
                const mensajes = {
                    'aceptado': '‚úÖ Turno aceptado correctamente',
                    'rechazado': '‚ùå Turno rechazado',
                    'atendido': '‚úîÔ∏è Turno marcado como atendido',
                    'no_asistio': 'üö´ Marcado como "No asisti√≥"'
                };
                
                showNotification(mensajes[nuevoEstado] || 'Turno actualizado', 'success');
                
                // Obtener turno antes de recargar
                const turnoAntes = state.turnos.find(t => t.id === turnoId);
                
                await cargarDatos();
                
                // Enviar emails seg√∫n el estado
                if (nuevoEstado === 'aceptado') {
                    const turnoActualizado = state.turnos.find(t => t.id === turnoId);
                    if (turnoActualizado) {
                        enviarEmailAceptacion(turnoActualizado).catch(err => {
                            console.warn('Email no enviado pero turno aceptado:', err);
                        });
                    }
                }
                
                // ========== ENVIAR EMAIL DE RECHAZO ==========
                if (nuevoEstado === 'rechazado' && turnoAntes) {
                    enviarEmailRechazo(turnoAntes, motivoRechazo).catch(err => {
                        console.warn('Email de rechazo no enviado:', err);
                    });
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function agregarNotaDECE(turnoId) {
            const nota = prompt('Agregar nota interna del DECE:');
            if (!nota) return;
            
            try {
                const { error } = await supabase.from('turnos').update({ nota_dece: nota }).eq('id', turnoId);
                if (error) throw error;
                await cargarDatos();
                showNotification('Nota agregada correctamente', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // RENDERIZADO
        function renderLogin() {
            return `
                <div class="flex items-center justify-center min-h-screen p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full relative overflow-hidden border-4 border-yellow-400">
                        <div class="absolute top-0 left-0 w-full h-3" style="background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);"></div>
                        
                        <div class="text-center mb-8">
                            <div class="flex justify-center mb-6">
                                <img src="https://i.ibb.co/wNhQpyX0/image-30.png" alt="UEPDC Logo" class="logo-institucional">
                            </div>
                            
                            <h1 class="text-4xl font-black mb-3" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                Sistema de Turnos DECE
                            </h1>
                            <p class="text-gray-700 text-lg font-semibold">Departamento de Consejer√≠a Estudiantil</p>
                            <div class="mt-4 inline-block px-5 py-2 rounded-full text-sm font-bold" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1e3a8a;">
                                üè´ UEPDC
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="grid grid-cols-3 gap-2 mb-6">
                                <button id="btnEstudiante" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                                    <span>üë®‚Äçüéì Estudiante</span>
                                </button>
                                <button id="btnProfesor" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                    <span>üë®‚Äçüè´ Profesor</span>
                                </button>
                                <button id="btnDECE" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                                    <span>üë®‚Äç‚öïÔ∏è DECE</span>
                                </button>
                            </div>
                        </div>

                        <div id="formContainer"></div>
                    </div>
                </div>
            `;
        }

        function renderFormEstudiante() {
            return `
                <div class="space-y-4 fade-in">
                    <div class="flex gap-2 border-b-2 pb-3" style="border-color: #60a5fa;">
                        <button id="btnLoginEst" class="flex-1 py-3 border-b-4 font-bold text-lg transition-all" style="border-color: #1e3a8a; color: #1e3a8a;">
                            Iniciar Sesi√≥n
                        </button>
                        <button id="btnRegistroEst" class="flex-1 py-3 text-gray-500 font-bold text-lg transition-all">
                            Registrarse
                        </button>
                    </div>
                    <div id="formEstudiante"></div>
                </div>
            `;
        }

        function renderLoginEstudiante() {
            return `
                <form id="loginEstForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìß Correo Institucional *</label>
                        <input type="email" name="email" required pattern=".+@est\.uepdc\.edu\.ec$" class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="nombre@est.uepdc.edu.ec">
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üîí Contrase√±a *</label>
                        <input type="password" name="password" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                        <span>üöÄ Iniciar Sesi√≥n</span>
                    </button>
                </form>
            `;
        }

        function renderRegistroEstudiante() {
            return `
                <form id="registroEstForm" class="space-y-4 fade-in max-h-[70vh] overflow-y-auto pr-2">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üë§ Nombre Completo *</label>
                        <input type="text" name="nombre" required minlength="5" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="Ej: Juan Andr√©s P√©rez G√≥mez">
                    </div>
                    
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìß Correo Institucional *</label>
                        <input type="email" name="email" required pattern=".+@est\.uepdc\.edu\.ec$" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="nombre@est.uepdc.edu.ec">
                    </div>
                    
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üÜî C√©dula *</label>
                        <input type="text" name="cedula" required pattern="[0-9]{10}" maxlength="10" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="0123456789">
                    </div>
                    
                    <div class="border-t-2 border-gray-200 pt-4">
                        <h3 class="font-black text-lg mb-3" style="color: #1e3a8a;">üìö Informaci√≥n Acad√©mica</h3>
                        
                        <div class="mb-4">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üéì Nivel Educativo *</label>
                            <select name="nivel" id="nivelSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Selecciona tu nivel</option>
                                <option value="Inicial">üë∂ Inicial</option>
                                <option value="Escuela">üìñ Escuela (1ro - 7mo EGB)</option>
                                <option value="B√°sica Superior">üìö B√°sica Superior (8vo - 10mo EGB)</option>
                                <option value="Bachillerato">üéì Bachillerato (1ro - 3ro BGU)</option>
                            </select>
                        </div>
                        
                        <div id="gradoContainer" class="mb-4" style="display: none;">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìù Curso *</label>
                            <select name="grado" id="gradoSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Primero selecciona el nivel</option>
                            </select>
                        </div>
                        
                        <div id="paraleloContainer" class="mb-4" style="display: none;">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìã Paralelo *</label>
                            <select name="paralelo" id="paraleloSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Primero selecciona el curso</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üîí Contrase√±a *</label>
                        <input type="password" name="password" required minlength="6" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                        <span>‚ú® Crear Cuenta</span>
                    </button>
                </form>
            `;
        }

        function renderFormProfesor() {
            return `
                <form id="loginProfForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #059669;">üìß Correo Institucional *</label>
                        <input type="email" name="email" required pattern=".+@uepdc\.edu\.ec$" class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #10b981;" placeholder="nombre@uepdc.edu.ec">
                        <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è No uses correos con @est.uepdc.edu.ec</p>
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        <span>üöÄ Acceder</span>
                    </button>
                </form>
            `;
        }

        function renderFormDECE() {
            return `
                <form id="loginDECEForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #f59e0b;">üìß Email *</label>
                        <input type="email" name="email" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #fbbf24;" placeholder="deceuepdcdece@uepdc.edu.ec">
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #f59e0b;">üîí Contrase√±a *</label>
                        <input type="password" name="password" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #fbbf24;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                        <span>üöÄ Iniciar Sesi√≥n</span>
                    </button>
                </form>
            `;
        }

        function renderEstudiante() {
            if (state.miTurno) {
                return `
                    <div class="min-h-screen p-6">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                                <div class="flex justify-between items-center">
                                    <h1 class="text-3xl font-black gradient-bg text-transparent bg-clip-text">Sistema de Turnos DECE</h1>
                                    <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all btn-modern">
                                        <span>üö™ Cerrar Sesi√≥n</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="miTurnoContent">
                                ${renderMiTurnoContent()}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h1 class="text-3xl font-black gradient-bg text-transparent bg-clip-text">Bienvenido/a ${state.usuarioActual.nombre}</h1>
                                    <p class="text-gray-600 text-lg mt-1">${state.usuarioActual.curso}</p>
                                </div>
                                <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all btn-modern">
                                    <span>üö™ Cerrar Sesi√≥n</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="estadoDECE" class="mb-6">
                            ${renderEstadoDECE()}
                        </div>
                        
                        ${state.estadoDECE.disponible ? renderFormularioTurno() : ''}
                        
                        ${renderHistorialEstudiante()}
                    </div>
                </div>
            `;
        }

        function renderEstadoDECE() {
            const disponible = state.estadoDECE.disponible;
            return `
                <div class="${disponible ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} p-10 rounded-2xl text-center text-white shadow-xl">
                    <div class="text-7xl mb-4">${disponible ? '‚úÖ' : '‚ùå'}</div>
                    <div class="text-4xl font-black mb-3">
                        ${disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                    </div>
                    <p class="text-xl opacity-90">${disponible ? '¬°Puedes solicitar un turno ahora!' : 'El DECE no est√° recibiendo solicitudes'}</p>
                </div>
            `;
        }

        function renderFormularioTurno() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                    <h2 class="text-2xl font-black mb-6 text-gray-800">üìù Solicitar Turno</h2>
                    <form id="formTurno">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üë§ Nombre</label>
                                <input type="text" name="nombre" value="${state.usuarioActual.nombre}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üÜî C√©dula</label>
                                <input type="text" name="cedula" value="${state.usuarioActual.cedula}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üìö Curso</label>
                                <input type="text" name="curso" value="${state.usuarioActual.curso}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üìã Motivo *</label>
                                <select name="motivo" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #60a5fa;">
                                    <option value="">Seleccione un motivo</option>
                                    <option value="Apoyo Acad√©mico">üìñ Apoyo Acad√©mico</option>
                                    <option value="Orientaci√≥n Personal">üí≠ Orientaci√≥n Personal</option>
                                    <option value="Dificultades Familiares">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dificultades Familiares</option>
                                    <option value="Problemas de Comportamiento">‚ö†Ô∏è Problemas de Comportamiento</option>
                                    <option value="Orientaci√≥n Vocacional">üéØ Orientaci√≥n Vocacional</option>
                                    <option value="Situaci√≥n de Riesgo">üö® Situaci√≥n de Riesgo</option>
                                    <option value="Problemas de Salud Mental">üß† Problemas de Salud Mental</option>
                                    <option value="Acoso Escolar (Bullying)">üõ°Ô∏è Acoso Escolar</option>
                                    <option value="Otros">üìù Otros</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block font-bold text-gray-700 mb-2">üí¨ Describe tu situaci√≥n *</label>
                            <textarea name="situacion" rows="4" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="Por favor describe tu situaci√≥n con detalle..."></textarea>
                        </div>
                        <button type="submit" ${!state.estadoDECE.disponible ? 'disabled' : ''} class="w-full gradient-bg text-white py-5 rounded-xl font-black text-xl hover:shadow-2xl transition-all disabled:bg-gray-400 disabled:cursor-not-allowed btn-modern">
                            <span>‚ú® Solicitar Turno</span>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderMiTurnoContent() {
            const turno = state.miTurno;
            
            let estaEnProceso = false;
            if (turno.hora_atencion_programada) {
                const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                if (horaInicio) {
                    estaEnProceso = HoraUtils.citaEnProceso(horaInicio);
                }
            }
            
            const turnosEnCola = state.turnos.filter(t => 
                (t.estado === 'pendiente' || t.estado === 'aceptado')
            ).sort((a, b) => a.numero_turno - b.numero_turno);
            
            const miPosicion = turnosEnCola.findIndex(t => t.id === turno.id) + 1;
            const totalEnCola = turnosEnCola.length;
            
            const turnosAceptadosAntes = state.turnos.filter(t => 
                t.estado === 'aceptado' && 
                t.numero_turno < turno.numero_turno
            ).length;
            
            return `
                ${(turno.estado === 'pendiente' || turno.estado === 'aceptado') ? `
                    <div class="gradient-bg text-white rounded-2xl p-10 text-center mb-6 shadow-2xl">
                        <div class="text-xl mb-3 font-semibold">üìä Tu posici√≥n en la fila</div>
                        <div class="text-8xl font-black my-6">#${miPosicion}</div>
                        <div class="text-2xl mb-4 font-bold">de ${totalEnCola} persona${totalEnCola !== 1 ? 's' : ''} esperando</div>
                        <div class="border-t-2 border-white/30 pt-6 mt-6 space-y-2">
                            <div class="text-lg">üìÖ ${new Date(turno.created_at).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <div class="text-lg">‚è∞ ${new Date(turno.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                            <div class="text-lg mt-4">üë§ ${turno.nombre}</div>
                            <div class="text-lg">üìö ${turno.curso}</div>
                            <div class="text-lg mt-2">üìã ${turno.motivo}</div>
                        </div>
                    </div>
                ` : `
                    <div class="gradient-bg text-white rounded-2xl p-10 text-center mb-6 shadow-2xl">
                        <div class="text-xl mb-3 font-semibold">Tu n√∫mero de turno</div>
                        <div class="text-8xl font-black my-6">#${turno.numero_turno}</div>
                        <div class="text-xl">üìÖ ${new Date(turno.created_at).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <div class="text-xl mt-2">‚è∞ ${new Date(turno.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="border-t-2 border-white/30 pt-6 mt-6 space-y-2">
                            <div class="text-xl">üë§ ${turno.nombre}</div>
                            <div class="text-xl">üìö ${turno.curso}</div>
                            <div class="text-xl mt-2">üìã ${turno.motivo}</div>
                        </div>
                    </div>
                `}
                
                ${estaEnProceso ? `
                    <div class="badge-en-proceso text-white p-8 rounded-2xl mb-6 text-center shadow-xl">
                        <div class="text-5xl mb-3">üîÑ</div>
                        <div class="text-3xl font-black">EN PROCESO</div>
                        <div class="text-lg mt-2">Tu cita est√° en curso: ${turno.hora_atencion_programada}</div>
                    </div>
                ` : ''}
                
                <div class="bg-white rounded-2xl p-8 shadow-xl mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã Estado de tu turno</h3>
                    ${renderEstadoTurno(turno)}
                </div>
                
                <button onclick="volverInicio()" class="w-full bg-gray-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-600 transition-all btn-modern">
                    <span>‚Üê Volver al inicio</span>
                </button>
            `;
        }

        function renderEstadoTurno(turno) {
            const estados = {
                'pendiente': { color: 'yellow', icon: '‚è≥', texto: 'Pendiente de revisi√≥n' },
                'aceptado': { color: 'green', icon: '‚úÖ', texto: 'Aceptado' },
                'rechazado': { color: 'red', icon: '‚ùå', texto: 'Rechazado' },
                'atendido': { color: 'blue', icon: '‚úîÔ∏è', texto: 'Atendido' },
                'no_asistio': { color: 'gray', icon: 'üö´', texto: 'No asisti√≥' }
            };
            
            const estado = estados[turno.estado] || estados.pendiente;
            
            return `
                <div class="bg-${estado.color}-100 border-2 border-${estado.color}-300 rounded-xl p-6">
                    <div class="flex items-center gap-4">
                        <span class="text-5xl">${estado.icon}</span>
                        <div>
                            <div class="text-2xl font-bold text-${estado.color}-700">${estado.texto}</div>
                            ${turno.hora_atencion_programada ? `
                                <div class="text-lg text-${estado.color}-600 mt-1">üïê Hora programada: ${turno.hora_atencion_programada}</div>
                            ` : ''}
                            ${turno.motivo_rechazo ? `
                                <div class="text-lg text-red-600 mt-2">üìù Motivo: ${turno.motivo_rechazo}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSinTurnos() {
            return `
                <div class="text-center py-16">
                    <div class="text-8xl mb-6">üì≠</div>
                    <h3 class="text-3xl font-bold text-gray-700 mb-3">No hay turnos</h3>
                    <p class="text-gray-500 text-lg">No se encontraron turnos con los filtros actuales</p>
                </div>
            `;
        }

        function renderTurnoCard(turno) {
            let estaEnProceso = false;
            if (turno.estado === 'aceptado' && turno.hora_atencion_programada) {
                const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                if (horaInicio) {
                    estaEnProceso = HoraUtils.citaEnProceso(horaInicio);
                }
            }
            
            const coloresEstado = {
                'pendiente': 'bg-yellow-100 border-yellow-300',
                'aceptado': estaEnProceso ? 'bg-orange-100 border-orange-400' : 'bg-green-100 border-green-300',
                'rechazado': 'bg-red-100 border-red-300',
                'atendido': 'bg-blue-100 border-blue-300',
                'no_asistio': 'bg-gray-100 border-gray-300'
            };
            
            const iconosEstado = {
                'pendiente': '‚è≥',
                'aceptado': estaEnProceso ? 'üîÑ' : '‚úÖ',
                'rechazado': '‚ùå',
                'atendido': '‚úîÔ∏è',
                'no_asistio': 'üö´'
            };
            
            const esSolicitadoPorProfesor = turno.solicitado_por === 'profesor';
            
            return `
                <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 ${coloresEstado[turno.estado]} card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${iconosEstado[turno.estado]}</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${turno.nombre}</h3>
                                <p class="text-gray-600">${turno.curso}</p>
                                ${esSolicitadoPorProfesor ? `
                                    <p class="text-sm text-purple-600 font-semibold mt-1">üë®‚Äçüè´ Solicitado por: ${turno.nombre_profesor || 'Profesor'}</p>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">#${turno.numero_turno}</div>
                            <div class="text-xs text-gray-400">${new Date(turno.created_at).toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div><span class="font-semibold">üìã Motivo:</span> ${turno.motivo}</div>
                        <div><span class="font-semibold">üìß Email:</span> ${turno.email_estudiante || 'N/A'}</div>
                        ${turno.hora_atencion_programada ? `
                            <div class="col-span-2"><span class="font-semibold">üïê Hora:</span> ${turno.hora_atencion_programada} 
                                <button onclick="editarHora(${turno.id}, '${turno.hora_atencion_programada}')" class="text-blue-500 hover:text-blue-700 ml-2">‚úèÔ∏è</button>
                            </div>
                        ` : ''}
                        ${estaEnProceso ? `
                            <div class="col-span-2 bg-orange-200 p-2 rounded text-center font-bold">üîÑ EN PROCESO AHORA</div>
                        ` : ''}
                    </div>
                    
                    ${turno.situacion ? `
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-gray-700 mb-1">üí¨ Situaci√≥n:</p>
                            <p class="text-gray-600 text-sm">${turno.situacion}</p>
                        </div>
                    ` : ''}
                    
                    ${turno.nota_dece ? `
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                            <p class="font-semibold text-blue-700 mb-1">üìù Nota DECE:</p>
                            <p class="text-blue-600 text-sm">${turno.nota_dece}</p>
                        </div>
                    ` : ''}
                    
                    ${turno.motivo_rechazo ? `
                        <div class="mb-4 p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
                            <p class="font-semibold text-red-700 mb-1">‚ùå Motivo de rechazo:</p>
                            <p class="text-red-600 text-sm">${turno.motivo_rechazo}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2 flex-wrap">
                        ${turno.estado === 'pendiente' ? `
                            <button onclick="aceptarTurnoConHora(${turno.id})" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 transition-all">
                                ‚úÖ Aceptar
                            </button>
                            <button onclick="rechazarTurno(${turno.id})" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 transition-all">
                                ‚ùå Rechazar
                            </button>
                        ` : ''}
                        
                        ${turno.estado === 'aceptado' ? `
                            <button onclick="marcarAtendido(${turno.id})" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-600 transition-all">
                                ‚úîÔ∏è Marcar Atendido
                            </button>
                            <button onclick="marcarNoAsistio(${turno.id})" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-600 transition-all">
                                üö´ No Asisti√≥
                            </button>
                        ` : ''}
                        
                        <button onclick="agregarNotaDECE(${turno.id})" class="bg-purple-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-600 transition-all">
                            üìù Nota
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHistorialEstudiante() {
            if (state.historialEstudiante.length === 0) return '';
            
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                    <h2 class="text-2xl font-black mb-6 text-gray-800">üìö Mi Historial</h2>
                    <div class="space-y-4">
                        ${state.historialEstudiante.map(turno => `
                            <div class="border-2 border-gray-200 rounded-xl p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-lg">Turno #${turno.numero_turno}</span>
                                    <span class="text-sm text-gray-500">${new Date(turno.created_at).toLocaleDateString('es-ES')}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <p><strong>Motivo:</strong> ${turno.motivo}</p>
                                    <p><strong>Estado:</strong> ${turno.estado}</p>
                                    ${turno.hora_atencion_programada ? `<p><strong>Hora:</strong> ${turno.hora_atencion_programada}</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderProfesor() {
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h1 class="text-3xl font-black" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                        Bienvenido/a Profesor/a ${state.usuarioActual.nombre}
                                    </h1>
                                    <p class="text-gray-600 text-lg mt-1">${state.usuarioActual.email}</p>
                                </div>
                                <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all btn-modern">
                                    <span>üö™ Cerrar Sesi√≥n</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="estadoDECE" class="mb-6">
                            ${renderEstadoDECE()}
                        </div>
                        
                        ${state.estadoDECE.disponible ? renderFormularioTurnoProfesor() : ''}
                    </div>
                </div>
            `;
        }

        function renderFormularioTurnoProfesor() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                    <h2 class="text-2xl font-black mb-6 text-gray-800">üë®‚Äçüè´ Solicitar Turno para un Estudiante</h2>
                    <form id="formTurnoProfesor">
                        <div class="mb-6">
                            <label class="block font-bold text-gray-700 mb-2">üìö Selecciona el Curso *</label>
                            <select id="cursoSelect" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #10b981;">
                                <option value="">Seleccione un curso</option>
                                ${Object.keys(ESTUDIANTES_BD).map(curso => 
                                    `<option value="${curso}">${curso}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block font-bold text-gray-700 mb-2">üë§ Selecciona el Estudiante *</label>
                            <select id="estudianteSelect" required disabled class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #10b981;">
                                <option value="">Primero selecciona un curso</option>
                            </select>
                        </div>
                        
                        <div id="estudianteInfo" class="mb-6 p-4 bg-green-50 rounded-xl hidden">
                            <h3 class="font-bold text-green-700 mb-2">üìã Informaci√≥n del Estudiante:</h3>
                            <p id="infoEstudiante" class="text-green-600"></p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block font-bold text-gray-700 mb-2">üìã Motivo de la Solicitud *</label>
                            <select name="motivo" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #10b981;">
                                <option value="">Seleccione un motivo</option>
                                <option value="Apoyo Acad√©mico">üìñ Apoyo Acad√©mico</option>
                                <option value="Orientaci√≥n Personal">üí≠ Orientaci√≥n Personal</option>
                                <option value="Dificultades Familiares">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dificultades Familiares</option>
                                <option value="Problemas de Comportamiento">‚ö†Ô∏è Problemas de Comportamiento</option>
                                <option value="Orientaci√≥n Vocacional">üéØ Orientaci√≥n Vocacional</option>
                                <option value="Situaci√≥n de Riesgo">üö® Situaci√≥n de Riesgo</option>
                                <option value="Problemas de Salud Mental">üß† Problemas de Salud Mental</option>
                                <option value="Acoso Escolar (Bullying)">üõ°Ô∏è Acoso Escolar</option>
                                <option value="Otros">üìù Otros</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block font-bold text-gray-700 mb-2">üí¨ Describe la situaci√≥n *</label>
                            <textarea name="situacion" rows="4" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #10b981;" placeholder="Por favor describe la situaci√≥n del estudiante con detalle..."></textarea>
                        </div>
                        
                        <button type="submit" class="w-full text-white py-5 rounded-xl font-black text-xl hover:shadow-2xl transition-all btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                            <span>‚ú® Solicitar Turno</span>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderDECE() {
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-black" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                        Panel de Control DECE
                                    </h1>
                                    <p class="text-gray-600 text-lg mt-1">Departamento de Consejer√≠a Estudiantil</p>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="refrescarManual()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all btn-modern">
                                        <span>üîÑ Refrescar</span>
                                    </button>
                                    <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all btn-modern">
                                        <span>üö™ Cerrar Sesi√≥n</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 control-disponible-card">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="control-disponible-icon">${state.estadoDECE.disponible ? 'üü¢' : 'üî¥'}</div>
                                    <div>
                                        <h2 class="control-disponible-title font-black text-gray-800">
                                            ${state.estadoDECE.disponible ? 'Sistema Activo' : 'Sistema Pausado'}
                                        </h2>
                                        <p class="control-disponible-text text-gray-600">
                                            ${state.estadoDECE.disponible ? 'Aceptando solicitudes de turnos' : 'No se est√°n aceptando nuevos turnos'}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="cambiarDisponibilidad()" class="control-disponible-btn ${state.estadoDECE.disponible ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-xl font-bold transition-all btn-modern">
                                    <span>${state.estadoDECE.disponible ? '‚è∏Ô∏è Pausar Sistema' : '‚ñ∂Ô∏è Activar Sistema'}</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="estadisticasContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                            ${renderEstadisticasHTML()}
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-black text-gray-800">üìã Gesti√≥n de Turnos</h2>
                                <div class="flex gap-2">
                                    <button onclick="filtrarTurnos('todos')" class="px-4 py-2 rounded-lg font-bold ${state.filtroTurnos === 'todos' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'} transition-all">
                                        Todos
                                    </button>
                                    <button onclick="filtrarTurnos('pendiente')" class="px-4 py-2 rounded-lg font-bold ${state.filtroTurnos === 'pendiente' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-700'} transition-all">
                                        Pendientes
                                    </button>
                                    <button onclick="filtrarTurnos('aceptado')" class="px-4 py-2 rounded-lg font-bold ${state.filtroTurnos === 'aceptado' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'} transition-all">
                                        Aceptados
                                    </button>
                                </div>
                            </div>
                            
                            <div id="listaTurnos" class="space-y-4">
                                ${state.turnos.length > 0 ? state.turnos.map(renderTurnoCard).join('') : renderSinTurnos()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEstadisticasHTML() {
            const stats = state.estadisticas;
            return `
                <div class="bg-blue-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.totalHoy}</div>
                    <div class="control-stats-label opacity-90">Hoy</div>
                </div>
                <div class="bg-yellow-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.pendientes}</div>
                    <div class="control-stats-label opacity-90">Pendientes</div>
                </div>
                <div class="bg-green-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.aceptados}</div>
                    <div class="control-stats-label opacity-90">Aceptados</div>
                </div>
                ${stats.enProceso > 0 ? `
                <div class="bg-orange-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.enProceso}</div>
                    <div class="control-stats-label opacity-90">En Proceso</div>
                </div>
                ` : ''}
                <div class="bg-indigo-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.atendidos}</div>
                    <div class="control-stats-label opacity-90">Atendidos</div>
                </div>
                <div class="bg-red-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.rechazados}</div>
                    <div class="control-stats-label opacity-90">Rechazados</div>
                </div>
                <div class="bg-gray-500 text-white p-6 rounded-xl shadow-lg card-hover control-stats-card">
                    <div class="control-stats-number font-black">${stats.no_asistio}</div>
                    <div class="control-stats-label opacity-90">No Asisti√≥</div>
                </div>
            `;
        }

        // EVENTOS
        function attachLoginEvents() {
            const btnEstudiante = document.getElementById('btnEstudiante');
            const btnProfesor = document.getElementById('btnProfesor');
            const btnDECE = document.getElementById('btnDECE');
            const formContainer = document.getElementById('formContainer');
            
            btnEstudiante?.addEventListener('click', () => {
                formContainer.innerHTML = renderFormEstudiante();
                attachEstudianteLoginEvents();
            });
            
            btnProfesor?.addEventListener('click', () => {
                formContainer.innerHTML = renderFormProfesor();
                attachProfesorEvents();
            });
            
            btnDECE?.addEventListener('click', () => {
                formContainer.innerHTML = renderFormDECE();
                attachDECEEvents();
            });
        }

        function attachEstudianteLoginEvents() {
            const btnLoginEst = document.getElementById('btnLoginEst');
            const btnRegistroEst = document.getElementById('btnRegistroEst');
            const formEstudiante = document.getElementById('formEstudiante');
            
            btnLoginEst?.addEventListener('click', () => {
                btnLoginEst.style.borderColor = '#1e3a8a';
                btnLoginEst.style.color = '#1e3a8a';
                btnRegistroEst.style.borderColor = 'transparent';
                btnRegistroEst.style.color = '#9ca3af';
                
                formEstudiante.innerHTML = renderLoginEstudiante();
                attachLoginEstudianteForm();
            });
            
            btnRegistroEst?.addEventListener('click', () => {
                btnRegistroEst.style.borderColor = '#1e3a8a';
                btnRegistroEst.style.color = '#1e3a8a';
                btnLoginEst.style.borderColor = 'transparent';
                btnLoginEst.style.color = '#9ca3af';
                
                formEstudiante.innerHTML = renderRegistroEstudiante();
                attachRegistroEstudianteForm();
            });
            
            formEstudiante.innerHTML = renderLoginEstudiante();
            attachLoginEstudianteForm();
        }

        function attachLoginEstudianteForm() {
            const form = document.getElementById('loginEstForm');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                await loginEstudiante(formData.get('email'), formData.get('password'));
            });
        }

        function attachRegistroEstudianteForm() {
            const form = document.getElementById('registroEstForm');
            const nivelSelect = document.getElementById('nivelSelect');
            const gradoContainer = document.getElementById('gradoContainer');
            const gradoSelect = document.getElementById('gradoSelect');
            const paraleloContainer = document.getElementById('paraleloContainer');
            const paraleloSelect = document.getElementById('paraleloSelect');
            
            const nivelesGrados = {
                'Inicial': ['Inicial 1', 'Inicial 2'],
                'Escuela': ['1ro EGB', '2do EGB', '3ro EGB', '4to EGB', '5to EGB', '6to EGB', '7mo EGB'],
                'B√°sica Superior': ['8vo EGB', '9no EGB', '10mo EGB'],
                'Bachillerato': ['1ro BGU', '2do BGU', '3ro BGU']
            };
            
            nivelSelect?.addEventListener('change', (e) => {
                const nivel = e.target.value;
                gradoSelect.innerHTML = '<option value="">Selecciona el curso</option>';
                paraleloSelect.innerHTML = '<option value="">Selecciona el paralelo</option>';
                
                if (nivel && nivelesGrados[nivel]) {
                    nivelesGrados[nivel].forEach(grado => {
                        const option = document.createElement('option');
                        option.value = grado;
                        option.textContent = grado;
                        gradoSelect.appendChild(option);
                    });
                    gradoContainer.style.display = 'block';
                    gradoSelect.disabled = false;
                } else {
                    gradoContainer.style.display = 'none';
                    paraleloContainer.style.display = 'none';
                }
            });
            
            gradoSelect?.addEventListener('change', (e) => {
                const grado = e.target.value;
                if (grado) {
                    paraleloSelect.innerHTML = '<option value="">Selecciona el paralelo</option>';
                    ['A', 'B', 'C', 'D', 'E', 'F'].forEach(paralelo => {
                        const option = document.createElement('option');
                        option.value = paralelo;
                        option.textContent = paralelo;
                        paraleloSelect.appendChild(option);
                    });
                    paraleloContainer.style.display = 'block';
                    paraleloSelect.disabled = false;
                } else {
                    paraleloContainer.style.display = 'none';
                }
            });
            
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const grado = formData.get('grado');
                const paralelo = formData.get('paralelo');
                const cursoCompleto = `${grado} - ${paralelo}`;
                
                await registrarEstudiante(
                    formData.get('nombre'),
                    formData.get('email'),
                    formData.get('cedula'),
                    cursoCompleto,
                    formData.get('password')
                );
            });
        }

        function attachDECEEvents() {
            const form = document.getElementById('loginDECEForm');
            form?.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const success = loginDECE(formData.get('email'), formData.get('password'));
                if (!success) {
                    showNotification('Credenciales incorrectas', 'error');
                }
            });
        }

        function attachProfesorEvents() {
            const formProf = document.getElementById('loginProfForm');
            if (formProf) {
                formProf.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    await loginProfesor(formData.get('email'));
                });
            }
            
            const cursoSelect = document.getElementById('cursoSelect');
            const estudianteSelect = document.getElementById('estudianteSelect');
            const estudianteInfo = document.getElementById('estudianteInfo');
            const infoEstudiante = document.getElementById('infoEstudiante');
            
            cursoSelect?.addEventListener('change', (e) => {
                const curso = e.target.value;
                estudianteSelect.innerHTML = '<option value="">Selecciona un estudiante</option>';
                
                if (curso && ESTUDIANTES_BD[curso]) {
                    ESTUDIANTES_BD[curso].forEach(estudiante => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(estudiante);
                        option.textContent = estudiante['Nombre completo estudiante'];
                        estudianteSelect.appendChild(option);
                    });
                    estudianteSelect.disabled = false;
                } else {
                    estudianteSelect.disabled = true;
                }
                
                estudianteInfo.classList.add('hidden');
            });
            
            estudianteSelect?.addEventListener('change', (e) => {
                if (e.target.value) {
                    const estudiante = JSON.parse(e.target.value);
                    infoEstudiante.textContent = `${estudiante['Nombre completo estudiante']} - ${estudiante['Email estudiante']}`;
                    estudianteInfo.classList.remove('hidden');
                } else {
                    estudianteInfo.classList.add('hidden');
                }
            });
            
            const formTurnoProf = document.getElementById('formTurnoProfesor');
            if (formTurnoProf) {
                formTurnoProf.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const estudianteSelect = document.getElementById('estudianteSelect');
                    if (!estudianteSelect.value) {
                        showNotification('Debes seleccionar un estudiante', 'error');
                        return;
                    }
                    
                    const estudiante = JSON.parse(estudianteSelect.value);
                    const curso = document.getElementById('cursoSelect').value;
                    const formData = new FormData(e.target);
                    
                    const turnoData = {
                        nombre: estudiante['Nombre completo estudiante'],
                        email_estudiante: estudiante['Email estudiante'],
                        cedula: 'N/A',
                        curso: curso,
                        motivo: formData.get('motivo'),
                        situacion: formData.get('situacion'),
                        solicitado_por: 'profesor',
                        email_profesor: state.usuarioActual.email,
                        nombre_profesor: state.usuarioActual.nombre
                    };
                    
                    await registrarTurnoProfesor(turnoData);
                });
            }
        }

        function attachEstudianteEvents() {
            const formTurno = document.getElementById('formTurno');
            if (formTurno) {
                formTurno.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    registrarTurno({
                        nombre: formData.get('nombre'),
                        cedula: formData.get('cedula'),
                        curso: formData.get('curso'),
                        motivo: formData.get('motivo'),
                        situacion: formData.get('situacion')
                    });
                });
            }
        }

        // Funciones globales
        window.cerrarSesion = cerrarSesion;
        window.cambiarDisponibilidad = cambiarDisponibilidad;
        window.agregarNotaDECE = agregarNotaDECE;
        
        window.refrescarManual = async () => {
            await cargarDatos();
            if (state.vista === 'dece') {
                render();
            }
            showNotification('Datos actualizados ‚úÖ', 'success');
        };
        
        window.aceptarTurnoConHora = async (id) => {
            const hora = prompt('üïê Hora de inicio (ej: 10:00):');
            if (hora && /^\d{1,2}:\d{2}$/.test(hora)) {
                const rangoCompleto = HoraUtils.generarRango(hora);
                await actualizarEstadoTurno(id, 'aceptado', null, rangoCompleto);
            } else if (hora) {
                showNotification('Formato inv√°lido', 'error');
            }
        };
        
        window.editarHora = async (id, horaActual) => {
            const hora = prompt('Modificar hora de inicio (formato 24h, ej: 10:00):', HoraUtils.extraerHoraInicio(horaActual) || '10:00');
            if (hora && hora !== horaActual && /^\d{1,2}:\d{2}$/.test(hora)) {
                try {
                    const rangoCompleto = HoraUtils.generarRango(hora);
                    
                    const { error } = await supabase.from('turnos').update({ 
                        hora_atencion_programada: rangoCompleto 
                    }).eq('id', id);
                    
                    if (error) throw error;
                    await cargarDatos();
                    showNotification('Hora actualizada con rango de 40 minutos ‚úÖ', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            } else if (hora && !/^\d{1,2}:\d{2}$/.test(hora)) {
                showNotification('Formato inv√°lido. Usa HH:MM (ej: 10:00)', 'error');
            }
        };
        
        window.rechazarTurno = (id) => {
            const motivo = prompt('Motivo del rechazo:');
            if (motivo) {
                actualizarEstadoTurno(id, 'rechazado', motivo);
            }
        };
        
        window.marcarAtendido = (id) => {
            if (confirm('¬øConfirmar atendido?')) {
                actualizarEstadoTurno(id, 'atendido');
            }
        };
        
        window.marcarNoAsistio = (id) => {
            if (confirm('¬øConfirmar no asisti√≥?')) {
                actualizarEstadoTurno(id, 'no_asistio');
            }
        };
        
        window.cerrarMiTurno = () => {
            state.miTurno = null;
            render();
        };
        
        window.verMiTurno = async () => {
            const miTurnoId = localStorage.getItem('miTurnoId');
            if (miTurnoId) {
                await cargarDatos();
                const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                if (turno) {
                    state.miTurno = turno;
                    render();
                } else {
                    localStorage.removeItem('miTurnoId');
                    showNotification('Turno no disponible', 'warning');
                    render();
                }
            }
        };
        
        window.volverInicio = () => {
            state.miTurno = null;
            localStorage.removeItem('miTurnoId');
            render();
        };
        
        window.filtrarTurnos = (filtro) => {
            state.filtroTurnos = filtro;
            actualizarListaTurnosUI();
        };

        // RENDERIZADO PRINCIPAL
        function render() {
            const app = document.getElementById('app');
            
            if (state.vista === 'login') {
                app.innerHTML = renderLogin();
                attachLoginEvents();
            } else if (state.vista === 'estudiante') {
                app.innerHTML = renderEstudiante();
                attachEstudianteEvents();
            } else if (state.vista === 'profesor') {
                app.innerHTML = renderProfesor();
                attachProfesorEvents();
            } else if (state.vista === 'dece') {
                app.innerHTML = renderDECE();
            }
        }

        // VERIFICAR SESI√ìN E INICIALIZACI√ìN
        function verificarSesion() {
            const sesion = localStorage.getItem('sesion');
            if (sesion) {
                const { tipo, usuario } = JSON.parse(sesion);
                state.tipoUsuario = tipo;
                state.vista = tipo;
                state.usuarioActual = usuario;
            }
        }

        // Auto-refresh OPTIMIZADO - 10 segundos
        let refreshInterval;
        
        function iniciarAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            refreshInterval = setInterval(async () => {
                if (state.configurado && (state.vista === 'estudiante' || state.vista === 'dece')) {
                    await cargarDatos();
                }
            }, 10000);
        }

        // Ocultar pantalla de carga
        function ocultarPantallaCarga() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
            }
        }

        // ========== INICIALIZACI√ìN OPTIMIZADA ==========
        async function init() {
            console.log('üöÄ Iniciando Sistema DECE...');
            const startTime = performance.now();
            
            // Inicializar EmailJS (as√≠ncrono, no bloquea)
            setTimeout(initEmailJS, 100);
            
            // Cargar datos en paralelo
            const [estudiantesOk] = await Promise.all([
                cargarEstudiantes(),
                verificarConfiguracion()
            ]);
            
            verificarSesion();
            
            if (state.vista !== 'login') {
                await cargarDatos();
                
                if (state.vista === 'estudiante') {
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId && state.turnos.length > 0) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => 
                        t.email_estudiante === state.usuarioActual.email
                    );
                }
            }
            
            render();
            iniciarAutoRefresh();
            
            // Ocultar pantalla de carga
            ocultarPantallaCarga();
            
            const endTime = performance.now();
            console.log(`‚úÖ Sistema listo en ${(endTime - startTime).toFixed(0)}ms`);
        }

        // Esperar a que el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
