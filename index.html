<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Turnos DECE - UEPDC</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/wNhQpyX0/image-30.png">
    <!-- Cargar Tailwind con defer para no bloquear -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar EmailJS con defer -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        /* PANTALLA DE CARGA */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-in-left { animation: slideInLeft 0.6s ease-out; }
        .slide-in-right { animation: slideInRight 0.6s ease-out; }
        .scale-in { animation: scaleIn 0.4s ease-out; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #3b82f6 100%);
        }
        
        .gradient-bg-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-bg-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-bg-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-modern:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-modern span {
            position: relative;
            z-index: 1;
        }
        
        .smooth-update {
            transition: all 0.3s ease;
        }
        
        .logo-institucional {
            width: 70px;
            height: 70px;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.2));
        }
        
        .badge-en-proceso {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }
        
        .select-modern {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
        }

        /* OPTIMIZACIONES RESPONSIVAS */
        .control-disponible-card {
            padding: 1.5rem;
            min-height: auto;
        }

        .control-disponible-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
        }

        .control-disponible-title {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .control-disponible-text {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .control-disponible-btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        .control-stats-card {
            padding: 1.25rem;
        }

        .control-stats-number {
            font-size: 2.5rem;
            margin-bottom: 0.25rem;
        }

        .control-stats-label {
            font-size: 0.875rem;
        }

        /* Ajustes para pantallas grandes */
        @media (min-width: 1400px) {
            .control-disponible-card {
                padding: 2rem;
            }
            
            .control-disponible-icon {
                font-size: 3.5rem;
            }
            
            .control-disponible-title {
                font-size: 2rem;
            }
        }

        /* Ajustes para pantallas muy grandes */
        @media (min-width: 1920px) {
            .control-disponible-card {
                padding: 2.5rem;
            }
            
            .control-disponible-icon {
                font-size: 4rem;
            }
            
            .control-disponible-title {
                font-size: 2.25rem;
            }

            .control-stats-number {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen relative overflow-x-hidden">
    <!-- PANTALLA DE CARGA -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSBEL" type="audio/wav">
    </audio>
    
    <div id="app"></div>

    <script>
        // SISTEMA DE NOTIFICACIONES
        function showNotification(mensaje, tipo = 'info') {
            const container = document.getElementById('notifications');
            const id = Date.now();
            
            const colores = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notif = document.createElement('div');
            notif.id = `notif-${id}`;
            notif.className = `${colores[tipo]} text-white px-6 py-4 rounded-xl shadow-2xl max-w-md fade-in`;
            notif.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : tipo === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span class="font-semibold">${mensaje}</span>
                </div>
            `;
            
            container.appendChild(notif);
            
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transform = 'translateX(400px)';
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }
        
        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            if (audio) {
                audio.play().catch(e => console.log('No se pudo reproducir el sonido'));
            }
        }
        
        // BASE DE DATOS DE CURSOS Y PARALELOS (desde Excel UEPDC) - CORREGIDO Y ORDENADO
        const CURSOS_PARALELOS = {
            "Inicial": {
                "cursos": [
                    "Inicial 1",
                    "Inicial 2"
                ],
                "paralelos": {
                    "Inicial 1": ["A"],
                    "Inicial 2": ["A", "B"]
                }
            },
            "Escuela": {
                "cursos": [
                    "Primer Grado EGB",
                    "Segundo Grado EGB",
                    "Tercer Grado EGB",
                    "Cuarto Grado EGB",
                    "Quinto Grado EGB",
                    "Sexto Grado EGB",
                    "S√©ptimo Grado EGB"
                ],
                "paralelos": {
                    "Primer Grado EGB": ["A", "B"],
                    "Segundo Grado EGB": ["A", "B"],
                    "Tercer Grado EGB": ["A", "B"],
                    "Cuarto Grado EGB": ["A", "B"],
                    "Quinto Grado EGB": ["A", "B"],
                    "Sexto Grado EGB": ["A", "B"],
                    "S√©ptimo Grado EGB": ["A"]
                }
            },
            "B√°sica Superior": {
                "cursos": [
                    "Octavo Grado EGB",
                    "Noveno Grado EGB",
                    "D√©cimo Grado EGB"
                ],
                "paralelos": {
                    "Octavo Grado EGB": ["A", "B", "C"],
                    "Noveno Grado EGB": ["A", "B", "C"],
                    "D√©cimo Grado EGB": ["A", "B", "C"]
                }
            },
            "Bachillerato": {
                "cursos": [
                    "Primer A√±o BGU - Ciencias",
                    "Primer A√±o BGU - TICS Inform√°tica",
                    "Primer A√±o BGU - Contable",
                    "Segundo A√±o BGU - Ciencias",
                    "Segundo A√±o BGU - TICS Inform√°tica",
                    "Segundo A√±o BGU - Contable",
                    "Tercer A√±o BGU - Ciencias",
                    "Tercer A√±o BGU - TICS Inform√°tica",
                    "Tercer A√±o BGU - Contable"
                ],
                "paralelos": {
                    "Primer A√±o BGU - Ciencias": ["A", "B"],
                    "Primer A√±o BGU - TICS Inform√°tica": ["A"],
                    "Primer A√±o BGU - Contable": ["A"],
                    "Segundo A√±o BGU - Ciencias": ["A", "B"],
                    "Segundo A√±o BGU - TICS Inform√°tica": ["A"],
                    "Segundo A√±o BGU - Contable": ["A"],
                    "Tercer A√±o BGU - Ciencias": ["A", "B"],
                    "Tercer A√±o BGU - TICS Inform√°tica": ["A", "B"],
                    "Tercer A√±o BGU - Contable": ["A"]
                }
            }
        };
        
        // Funci√≥n para ordenar cursos en el orden correcto: Inicial ‚Üí Bachillerato
        function ordenarCursosCorrectamente(cursos) {
            const ordenPrioridad = {
                // Inicial
                'Inicial 1 A - Inicial': 1,
                'Inicial 2 A - Inicial': 2,
                'Inicial 2 B - Inicial': 3,
                
                // Preparatoria (Primero)
                'Primer Grado A - Preparatoria': 10,
                'Primer Grado B - Preparatoria': 11,
                
                // Educaci√≥n General B√°sica (EGB) - Segundo a S√©ptimo
                'Segundo Grado A - Educaci√≥n General B√°sica': 12,
                'Segundo Grado B - Educaci√≥n General B√°sica': 13,
                'Tercer Grado A - Educaci√≥n General B√°sica': 14,
                'Tercer Grado B - Educaci√≥n General B√°sica': 15,
                'Cuarto Grado A - Educaci√≥n General B√°sica': 16,
                'Cuarto Grado B - Educaci√≥n General B√°sica': 17,
                'Quinto Grado A - Educaci√≥n General B√°sica': 18,
                'Quinto Grado B - Educaci√≥n General B√°sica': 19,
                'Sexto Grado A - Educaci√≥n General B√°sica': 20,
                'Sexto Grado B - Educaci√≥n General B√°sica': 21,
                'S√©ptimo Grado A - Educaci√≥n General B√°sica': 22,
                
                // Educaci√≥n General B√°sica (EGB) - Octavo a D√©cimo
                'Octavo Grado A - Educaci√≥n General B√°sica': 23,
                'Octavo Grado B - Educaci√≥n General B√°sica': 24,
                'Octavo Grado C - Educaci√≥n General B√°sica': 25,
                'Noveno Grado A - Educaci√≥n General B√°sica': 26,
                'Noveno Grado B - Educaci√≥n General B√°sica': 27,
                'Noveno Grado C - Educaci√≥n General B√°sica': 28,
                'D√©cimo Grado A - Educaci√≥n General B√°sica': 29,
                'D√©cimo Grado B - Educaci√≥n General B√°sica': 30,
                'D√©cimo Grado C - Educaci√≥n General B√°sica': 31,
                
                // Bachillerato - Primer A√±o (NOMBRES SIMPLIFICADOS)
                'Primer A√±o BGU A - Bachillerato Ciencias': 40,
                'Primer A√±o BGU B - Bachillerato Ciencias': 41,
                'Primer A√±o BGU A - Bachillerato TICS Inform√°tica': 42,
                'Primer A√±o BGU A - Bachillerato Contabilidad': 43,
                
                // Bachillerato - Segundo A√±o (NOMBRES SIMPLIFICADOS)
                'Segundo A√±o BGU A - Bachillerato Ciencias': 50,
                'Segundo A√±o BGU B - Bachillerato Ciencias': 51,
                'Segundo A√±o BGU A - Bachillerato TICS Inform√°tica': 52,
                'Segundo A√±o BGU A - Bachillerato Contabilidad': 53,
                
                // Bachillerato - Tercer A√±o (NOMBRES SIMPLIFICADOS)
                'Tercer A√±o BGU A - Bachillerato Ciencias': 60,
                'Tercer A√±o BGU B - Bachillerato Ciencias': 61,
                'Tercer A√±o BGU A - Bachillerato TICS Inform√°tica': 62,
                'Tercer A√±o BGU B - Bachillerato TICS Inform√°tica': 63
            };
            
            return cursos.sort((a, b) => {
                const prioridadA = ordenPrioridad[a] || 9999;
                const prioridadB = ordenPrioridad[b] || 9999;
                
                // Si tienen prioridad definida, ordenar por prioridad
                if (prioridadA !== 9999 || prioridadB !== 9999) {
                    return prioridadA - prioridadB;
                }
                
                // Si no tienen prioridad, ordenar alfab√©ticamente
                return a.localeCompare(b, 'es');
            });
        }
        
        
        // BASE DE DATOS DE ESTUDIANTES
        let ESTUDIANTES_BD = {};
        
        // Cargar base de datos de estudiantes - OPTIMIZADO
        async function cargarEstudiantes() {
            try {
                const response = await fetch('estudiantes_uepdc.json');
                if (!response.ok) throw new Error('No se pudo cargar la base de datos');
                ESTUDIANTES_BD = await response.json();
                console.log('‚úÖ Base de datos de estudiantes cargada:', Object.keys(ESTUDIANTES_BD).length, 'cursos');
                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar estudiantes:', error);
                // No mostrar notificaci√≥n para no bloquear la carga
                return false;
            }
        }
        
        // Buscar estudiante por email
        function buscarEstudiantePorEmail(email) {
            for (const curso in ESTUDIANTES_BD) {
                const estudiante = ESTUDIANTES_BD[curso].find(e => 
                    e['Email estudiante'].toLowerCase() === email.toLowerCase()
                );
                if (estudiante) {
                    return {
                        nombre: estudiante['Nombre completo estudiante'],
                        email: estudiante['Email estudiante'],
                        curso: curso
                    };
                }
            }
            return null;
        }
        
        // CONFIGURACI√ìN DE EMAILJS - ACTUALIZADO CON TEMPLATES DE RECHAZO
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: 'RtA5YFyTxrNjrb_CX',
            SERVICE_ID: 'service_83qp86c',
            TEMPLATE_ACEPTADO_UNIFICADO: 'template_oozm99r',
            TEMPLATE_RECHAZO_UNIFICADO: 'template_x6r7fzo'
        };
        
        // Variable para controlar si EmailJS est√° listo
        let emailJSReady = false;
        
        // Inicializar EmailJS - OPTIMIZADO (se ejecuta cuando el DOM est√° listo)
        function initEmailJS() {
            try {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
                    emailJSReady = true;
                    console.log('‚úÖ EmailJS inicializado correctamente');
                } else {
                    console.warn('‚ö†Ô∏è EmailJS a√∫n no est√° disponible, reintentando...');
                    setTimeout(initEmailJS, 500);
                }
            } catch (error) {
                console.error('‚ùå Error al inicializar EmailJS:', error);
            }
        }
        
        // FUNCI√ìN DE ENV√çO DE EMAIL - ACEPTACI√ìN
        async function enviarEmailAceptacion(turno) {
            console.log('üìß INICIANDO ENV√çO DE EMAIL DE ACEPTACI√ìN');
            
            if (!emailJSReady || typeof emailjs === 'undefined') {
                console.warn('‚ö†Ô∏è EmailJS no est√° disponible');
                return false;
            }
            
            if (!turno || typeof turno !== 'object') {
                console.error('‚ùå Turno no v√°lido');
                return false;
            }
            
            let emailEstudiante = turno.email_estudiante || turno.correo_estudiante || turno.email;
            
            if (!emailEstudiante) {
                console.error('‚ùå Email es NULL o undefined');
                return false;
            }
            
            const emailEstudianteLimpio = String(emailEstudiante).trim();
            const emailProfesor = String(turno.email_profesor || '').trim();
            const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!regexEmail.test(emailEstudianteLimpio)) {
                console.error('‚ùå Email del estudiante con formato inv√°lido:', emailEstudianteLimpio);
                return false;
            }
            
            try {
                const fechaSolicitud = turno.created_at 
                    ? new Date(turno.created_at).toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })
                    : 'No disponible';
                
                const horaSolicitud = turno.created_at
                    ? new Date(turno.created_at).toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })
                    : 'No disponible';
                
                // Template params - funciona para ambos casos (estudiante y profesor)
                const templateParams = {
                    to_email: emailEstudianteLimpio,
                    reply_to: emailEstudianteLimpio,
                    to_name: String(turno.nombre || 'Estudiante'),
                    student_name: String(turno.nombre || 'Estudiante'),
                    turno_numero: String(turno.numero_turno || turno.id || 'N/A'),
                    fecha_solicitud: String(fechaSolicitud),
                    hora_solicitud: String(horaSolicitud),
                    hora_atencion: String(turno.hora_atencion_programada || 'Por confirmar'),
                    motivo: String(turno.motivo || 'No especificado'),
                    curso: String(turno.curso || 'No especificado'),
                    cedula: String(turno.cedula || 'No especificada'),
                    teacher_name: String(turno.nombre_profesor || ''),
                    teacher_email: emailProfesor
                };
                
                console.log('üìß Preparando env√≠o de email...');
                console.log('Service ID:', EMAILJS_CONFIG.SERVICE_ID);
                console.log('Template ID:', EMAILJS_CONFIG.TEMPLATE_ACEPTADO_UNIFICADO);
                console.log('Params:', templateParams);
                
                // Enviar al estudiante
                await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ACEPTADO_UNIFICADO,
                    templateParams
                );
                console.log('‚úÖ Email de aceptaci√≥n enviado al estudiante');
                
                // Si fue solicitado por profesor, tambi√©n enviar al profesor
                if (turno.solicitado_por === 'profesor' && regexEmail.test(emailProfesor)) {
                    templateParams.to_email = emailProfesor;
                    templateParams.to_name = turno.nombre_profesor;
                    
                    await emailjs.send(
                        EMAILJS_CONFIG.SERVICE_ID,
                        EMAILJS_CONFIG.TEMPLATE_ACEPTADO_UNIFICADO,
                        templateParams
                    );
                    console.log('‚úÖ Email de aceptaci√≥n enviado al profesor');
                    showNotification(`üìß Notificaciones enviadas al estudiante y profesor`, 'success');
                } else {
                    showNotification(`üìß Email enviado a ${emailEstudianteLimpio}`, 'success');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå ERROR AL ENVIAR EMAIL:', error);
                return false;
            }
        }
        
        // ========== FUNCI√ìN UNIFICADA: EMAIL DE RECHAZO ==========
        async function enviarEmailRechazo(turno, motivoRechazo) {
            console.log('üìß ENVIANDO EMAIL DE RECHAZO');
            
            if (!emailJSReady || typeof emailjs === 'undefined') {
                console.warn('‚ö†Ô∏è EmailJS no est√° disponible');
                return false;
            }
            
            if (!turno || !turno.email_estudiante) {
                console.error('‚ùå Datos del turno incompletos');
                return false;
            }
            
            const emailEstudiante = String(turno.email_estudiante || '').trim();
            const emailProfesor = String(turno.email_profesor || '').trim();
            const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!regexEmail.test(emailEstudiante)) {
                console.error('‚ùå Email del estudiante inv√°lido');
                return false;
            }
            
            try {
                const fechaSolicitud = turno.created_at 
                    ? new Date(turno.created_at).toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })
                    : 'No disponible';
                
                // Template params - funciona para ambos casos
                const templateParams = {
                    to_email: emailEstudiante,
                    reply_to: emailEstudiante,
                    to_name: String(turno.nombre || 'Estudiante'),
                    student_name: String(turno.nombre || 'Estudiante'),
                    turno_numero: String(turno.numero_turno || turno.id || 'N/A'),
                    fecha_solicitud: fechaSolicitud,
                    motivo_turno: String(turno.motivo || 'No especificado'),
                    motivo_rechazo: String(motivoRechazo || 'No especificado'),
                    curso: String(turno.curso || 'No especificado'),
                    teacher_name: String(turno.nombre_profesor || ''),
                    teacher_email: emailProfesor
                };
                
                console.log('üìß Preparando env√≠o de email de RECHAZO...');
                console.log('Service ID:', EMAILJS_CONFIG.SERVICE_ID);
                console.log('Template ID:', EMAILJS_CONFIG.TEMPLATE_RECHAZO_UNIFICADO);
                console.log('Params:', templateParams);
                
                // Enviar al estudiante
                await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_RECHAZO_UNIFICADO,
                    templateParams
                );
                console.log('‚úÖ Email de rechazo enviado al estudiante');
                
                // Si fue solicitado por profesor, tambi√©n enviar al profesor
                if (turno.solicitado_por === 'profesor' && regexEmail.test(emailProfesor)) {
                    templateParams.to_email = emailProfesor;
                    templateParams.to_name = turno.nombre_profesor;
                    
                    await emailjs.send(
                        EMAILJS_CONFIG.SERVICE_ID,
                        EMAILJS_CONFIG.TEMPLATE_RECHAZO_UNIFICADO,
                        templateParams
                    );
                    console.log('‚úÖ Email de rechazo enviado al profesor');
                    showNotification(`üìß Notificaciones de rechazo enviadas al estudiante y profesor`, 'info');
                } else {
                    showNotification(`üìß Notificaci√≥n de rechazo enviada`, 'info');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå ERROR AL ENVIAR EMAIL DE RECHAZO:', error);
                return false;
            }
        }
        
        // CONFIGURACI√ìN DE SUPABASE
        const SUPABASE_URL = 'https://hynubiwdlpkfzqgzahlp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5bnViaXdkbHBrZnpxZ3phaGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDM1MzYsImV4cCI6MjA3OTE3OTUzNn0.xbiu1OVD9I8V_NYj0gem1zK5wICW_cXrxIoRRwQFbAg';

        const DECE_CREDENTIALS = {
            email: 'deceuepdcdece@uepdc.edu.ec',
            password: 'geraldmontoya'
        };

        // UTILIDADES DE HORA - ECUADOR
        const HoraUtils = {
            getHoraEcuador() {
                const ahora = new Date();
                try {
                    const opciones = { 
                        timeZone: 'America/Guayaquil', 
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };
                    
                    const formateador = new Intl.DateTimeFormat('es-EC', opciones);
                    const partes = formateador.formatToParts(ahora);
                    
                    const valores = {};
                    partes.forEach(parte => {
                        if (parte.type !== 'literal') {
                            valores[parte.type] = parte.value;
                        }
                    });
                    
                    const horaEcuador = new Date(
                        parseInt(valores.year),
                        parseInt(valores.month) - 1,
                        parseInt(valores.day),
                        parseInt(valores.hour),
                        parseInt(valores.minute),
                        parseInt(valores.second)
                    );
                    
                    return horaEcuador;
                    
                } catch (error) {
                    const utc = ahora.getTime() + (ahora.getTimezoneOffset() * 60000);
                    return new Date(utc + (-5 * 3600000));
                }
            },
            
            horaAMinutos(hora) {
                const [h, m] = hora.split(':').map(Number);
                return h * 60 + m;
            },
            
            minutosAHora(minutos) {
                const h = Math.floor(minutos / 60);
                const m = minutos % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            },
            
            agregarMinutos(hora, minutos) {
                const minutosActual = this.horaAMinutos(hora);
                const nuevosMinutos = minutosActual + minutos;
                return this.minutosAHora(nuevosMinutos);
            },
            
            formatearAMPM(hora) {
                const [h, m] = hora.split(':').map(Number);
                const ampm = h >= 12 ? 'p.m' : 'a.m';
                const hora12 = h % 12 || 12;
                return `${hora12}:${m.toString().padStart(2, '0')} ${ampm}`;
            },
            
            generarRango(horaInicio) {
                const horaFin = this.agregarMinutos(horaInicio, 40);
                return `${this.formatearAMPM(horaInicio)} a ${this.formatearAMPM(horaFin)}`;
            },
            
            citaYaTermino(horaInicio) {
                const horaEcuador = this.getHoraEcuador();
                const horaActualMinutos = horaEcuador.getHours() * 60 + horaEcuador.getMinutes();
                const horaInicioMinutos = this.horaAMinutos(horaInicio);
                const horaFinMinutos = horaInicioMinutos + 40;
                return horaActualMinutos >= horaFinMinutos;
            },
            
            citaEnProceso(horaInicio) {
                const horaEcuador = this.getHoraEcuador();
                const horaActualMinutos = horaEcuador.getHours() * 60 + horaEcuador.getMinutes();
                const horaInicioMinutos = this.horaAMinutos(horaInicio);
                const horaFinMinutos = horaInicioMinutos + 40;
                return horaActualMinutos >= horaInicioMinutos && horaActualMinutos < horaFinMinutos;
            },
            
            extraerHoraInicio(rangoHora) {
                const match = rangoHora.match(/(\d{1,2}):(\d{2})\s*(a\.m|p\.m)/);
                if (!match) return null;
                
                let hora = parseInt(match[1]);
                const minutos = match[2];
                const periodo = match[3];
                
                if (periodo === 'p.m' && hora !== 12) {
                    hora += 12;
                } else if (periodo === 'a.m' && hora === 12) {
                    hora = 0;
                }
                
                return `${hora.toString().padStart(2, '0')}:${minutos}`;
            }
        };

        // ESTADO DE LA APLICACI√ìN
        let state = {
            vista: 'login',
            tipoUsuario: null,
            usuarioActual: null,
            configurado: false,
            estadoDECE: { id: 1, disponible: true },
            turnos: [],
            miTurno: null,
            estadisticas: {
                totalHoy: 0,
                pendientes: 0,
                aceptados: 0,
                enProceso: 0,
                atendidos: 0,
                rechazados: 0,
                no_asistio: 0
            },
            filtroTurnos: 'todos',
            busqueda: '',
            historialEstudiante: [],
            mostrarHistorial: false
        };

        // CLIENTE SUPABASE - OPTIMIZADO
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}`, {
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    });
                    const data = await response.json();
                    return { data, error: response.ok ? null : data };
                },
                insert: async (values) => {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(values)
                    });
                    const data = await response.json();
                    return { data, error: response.ok ? null : data };
                },
                update: (values) => ({
                    eq: async (column, value) => {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify(values)
                        });
                        const data = await response.json();
                        return { data, error: response.ok ? null : data };
                    }
                }),
                delete: () => ({
                    eq: async (column, value) => {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                            method: 'DELETE',
                            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                        });
                        return { error: response.ok ? null : await response.json() };
                    }
                })
            })
        };

        // FUNCIONES DE DATOS
        async function verificarYActualizarEstadosTurnos(turnos) {
            for (const turno of turnos) {
                if (turno.estado === 'aceptado' && turno.hora_atencion_programada) {
                    const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                    
                    if (!horaInicio) continue;
                    
                    if (HoraUtils.citaYaTermino(horaInicio)) {
                        console.log(`‚úÖ Auto-marcando turno ${turno.id} como ATENDIDO (cita terminada)`);
                        await supabase.from('turnos').update({ 
                            estado: 'atendido',
                            hora_atencion: new Date().toISOString()
                        }).eq('id', turno.id);
                    }
                }
            }
        }
        
        async function cargarDatos() {
            try {
                const { data: config } = await supabase.from('configuracion').select('*');
                if (config && config.length > 0) {
                    const nuevoEstado = config[0].disponible;
                    if (state.estadoDECE.disponible !== nuevoEstado) {
                        state.estadoDECE = config[0];
                        actualizarEstadoDECEUI();
                    }
                }
                
                const { data: turnosData } = await supabase.from('turnos').select('*');
                if (turnosData) {
                    await verificarYActualizarEstadosTurnos(turnosData);
                    
                    const { data: turnosActualizados } = await supabase.from('turnos').select('*');
                    const turnosOrdenados = turnosActualizados.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    state.turnos = turnosOrdenados;
                    calcularEstadisticas();
                    
                    if (state.vista === 'dece') {
                        actualizarEstadisticasUI();
                        actualizarListaTurnosUI();
                    }
                }
                
                const miTurnoId = localStorage.getItem('miTurnoId');
                if (miTurnoId && turnosData) {
                    const turnoActualizado = state.turnos.find(t => t.id === parseInt(miTurnoId));
                    if (turnoActualizado) {
                        state.miTurno = turnoActualizado;
                        
                        if (state.vista === 'estudiante' && state.miTurno) {
                            actualizarMiTurnoUI();
                        }
                    } else {
                        state.miTurno = null;
                        localStorage.removeItem('miTurnoId');
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        function calcularEstadisticas() {
            const hoy = new Date().toLocaleDateString('es-ES');
            const turnosHoy = state.turnos.filter(t => 
                new Date(t.created_at).toLocaleDateString('es-ES') === hoy
            );
            
            let enProceso = 0;
            state.turnos.forEach(t => {
                if (t.estado === 'aceptado' && t.hora_atencion_programada) {
                    const horaInicio = HoraUtils.extraerHoraInicio(t.hora_atencion_programada);
                    if (horaInicio && HoraUtils.citaEnProceso(horaInicio)) {
                        enProceso++;
                    }
                }
            });
            
            state.estadisticas = {
                totalHoy: turnosHoy.length,
                pendientes: state.turnos.filter(t => t.estado === 'pendiente').length,
                aceptados: state.turnos.filter(t => t.estado === 'aceptado').length,
                enProceso: enProceso,
                atendidos: state.turnos.filter(t => t.estado === 'atendido').length,
                rechazados: state.turnos.filter(t => t.estado === 'rechazado').length,
                no_asistio: state.turnos.filter(t => t.estado === 'no_asistio').length
            };
        }

        async function verificarConfiguracion() {
            try {
                const { data, error } = await supabase.from('configuracion').select('*');
                if (!error) {
                    state.configurado = true;
                    if (data && data.length > 0) {
                        state.estadoDECE = data[0];
                    }
                    await cargarDatos();
                }
            } catch (err) {
                state.configurado = false;
            }
        }

        // FUNCIONES DE ACTUALIZACI√ìN UI
        function actualizarEstadoDECEUI() {
            const elemento = document.getElementById('estadoDECE');
            if (!elemento) return;
            
            const disponible = state.estadoDECE.disponible;
            elemento.innerHTML = `
                <div class="${disponible ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} p-10 rounded-2xl text-center text-white shadow-xl smooth-update">
                    <div class="text-7xl mb-4">${disponible ? '‚úÖ' : '‚ùå'}</div>
                    <div class="text-4xl font-black mb-3">
                        ${disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                    </div>
                    <p class="text-xl opacity-90">${disponible ? '¬°Puedes solicitar un turno ahora!' : 'El DECE no est√° recibiendo solicitudes'}</p>
                </div>
            `;
        }
        
        function actualizarEstadisticasUI() {
            const elemento = document.getElementById('estadisticas');
            if (!elemento) return;
            
            elemento.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-5 rounded-2xl text-center border-2 border-gray-300 card-hover">
                        <div class="text-3xl font-black text-gray-700 mb-1">${state.estadisticas.totalHoy}</div>
                        <div class="text-xs text-gray-600 font-semibold">üìã Total hoy</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-5 rounded-2xl text-center border-2 border-yellow-300 card-hover">
                        <div class="text-3xl font-black text-yellow-700 mb-1">${state.turnos.filter(t => t.estado === 'pendiente' && new Date(t.created_at).toLocaleDateString('es-ES') === new Date().toLocaleDateString('es-ES')).length}</div>
                        <div class="text-xs text-yellow-600 font-semibold">‚è≥ Pendientes</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-2xl text-center border-2 border-orange-300 card-hover">
                        <div class="text-3xl font-black text-orange-700 mb-1">${state.estadisticas.enProceso}</div>
                        <div class="text-xs text-orange-600 font-semibold">üîÑ En proceso</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl text-center border-2 border-blue-300 card-hover">
                        <div class="text-3xl font-black text-blue-700 mb-1">${state.turnos.filter(t => t.estado === 'atendido' && new Date(t.created_at).toLocaleDateString('es-ES') === new Date().toLocaleDateString('es-ES')).length}</div>
                        <div class="text-xs text-blue-600 font-semibold">‚úîÔ∏è Completados</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl text-center border-2 border-red-300 card-hover">
                        <div class="text-3xl font-black text-red-700 mb-1">${state.estadisticas.no_asistio}</div>
                        <div class="text-xs text-red-600 font-semibold">üö´ No asisti√≥</div>
                    </div>
                </div>
            `;
            
            actualizarControlUI();
        }
        
        function actualizarControlUI() {
            const tarjetasPequenas = document.querySelector('.grid.grid-cols-2.gap-3');
            if (tarjetasPequenas) {
                tarjetasPequenas.innerHTML = `
                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                        <div class="control-stats-number font-black">${state.estadisticas.pendientes}</div>
                        <div class="control-stats-label font-semibold opacity-90">‚è≥ Pendientes</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-400 to-green-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                        <div class="control-stats-number font-black">${state.estadisticas.aceptados}</div>
                        <div class="control-stats-label font-semibold opacity-90">‚úÖ Aceptados</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-400 to-orange-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                        <div class="control-stats-number font-black">${state.estadisticas.enProceso}</div>
                        <div class="control-stats-label font-semibold opacity-90">üîÑ En proceso</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-400 to-blue-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                        <div class="control-stats-number font-black">${state.estadisticas.atendidos}</div>
                        <div class="control-stats-label font-semibold opacity-90">‚úîÔ∏è Atendidos</div>
                    </div>
                `;
            }
        }
        
        function actualizarListaTurnosUI() {
            const elemento = document.getElementById('listaTurnos');
            if (!elemento) return;
            
            const turnosFiltrados = filtrarYBuscarTurnos();
            
            if (turnosFiltrados.length === 0) {
                elemento.innerHTML = renderSinTurnos();
                return;
            }
            
            elemento.innerHTML = `
                <div class="space-y-4">
                    ${turnosFiltrados.map(turno => renderTurnoCard(turno)).join('')}
                </div>
            `;
        }
        
        function actualizarMiTurnoUI() {
            const elemento = document.getElementById('miTurnoContainer');
            if (!elemento || !state.miTurno) return;
            
            elemento.innerHTML = renderMiTurnoContent();
        }
        
        function filtrarYBuscarTurnos() {
            let turnosFiltrados = state.filtroTurnos === 'todos' 
                ? state.turnos 
                : state.filtroTurnos === 'en_proceso'
                ? state.turnos.filter(t => {
                    if (t.estado === 'aceptado' && t.hora_atencion_programada) {
                        const horaInicio = HoraUtils.extraerHoraInicio(t.hora_atencion_programada);
                        return horaInicio && HoraUtils.citaEnProceso(horaInicio);
                    }
                    return false;
                })
                : state.turnos.filter(t => t.estado === state.filtroTurnos);
            
            if (state.busqueda) {
                const busqueda = state.busqueda.toLowerCase();
                turnosFiltrados = turnosFiltrados.filter(t => 
                    t.nombre.toLowerCase().includes(busqueda) ||
                    t.cedula.includes(busqueda) ||
                    t.curso.toLowerCase().includes(busqueda) ||
                    t.email_estudiante?.toLowerCase().includes(busqueda)
                );
            }
            
            return turnosFiltrados;
        }

        // AUTENTICACI√ìN
        async function loginEstudiante(email, password) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&password=eq.${encodeURIComponent(password)}&select=*`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                const usuarios = await response.json();
                
                if (!response.ok || !usuarios || usuarios.length === 0) {
                    const usuariosLocal = JSON.parse(localStorage.getItem('usuarios_estudiantes') || '[]');
                    const usuario = usuariosLocal.find(u => u.email === email && u.password === password);
                    if (!usuario) return false;
                    
                    state.usuarioActual = usuario;
                    state.tipoUsuario = 'estudiante';
                    state.vista = 'estudiante';
                    localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario }));
                    
                    await cargarDatos();
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                        else localStorage.removeItem('miTurnoId');
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => t.email_estudiante === email);
                    render();
                    showNotification(`¬°Bienvenido/a ${usuario.nombre}!`, 'success');
                    return true;
                }
                
                if (usuarios && usuarios.length > 0) {
                    const usuario = usuarios[0];
                    state.usuarioActual = usuario;
                    state.tipoUsuario = 'estudiante';
                    state.vista = 'estudiante';
                    localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario }));
                    
                    await cargarDatos();
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                        else localStorage.removeItem('miTurnoId');
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => t.email_estudiante === email);
                    render();
                    showNotification(`¬°Bienvenido/a ${usuario.nombre}!`, 'success');
                    return true;
                }
                
                return false;
            } catch (err) {
                console.error('‚ùå Error en loginEstudiante:', err);
                return false;
            }
        }

        async function registrarEstudiante(datosFormulario) {
            try {
                const { nombre, email, cedula, nivel, grado, paralelo, password } = datosFormulario;
                
                if (!email.endsWith('@est.uepdc.edu.ec')) {
                    showNotification('‚ùå Debes usar tu correo institucional (@est.uepdc.edu.ec)', 'error');
                    return false;
                }
                
                const palabrasNombre = nombre.trim().split(/\s+/);
                if (palabrasNombre.length < 2) {
                    showNotification('‚ùå Ingresa tu nombre completo (nombre y apellido)', 'error');
                    return false;
                }
                
                const cursoCompleto = `${grado} ${paralelo}`;
                
                const responseEmail = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?email=eq.${encodeURIComponent(email)}&select=email`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                const emailData = await responseEmail.json();
                
                if (emailData && emailData.length > 0) {
                    showNotification('El correo ya est√° registrado', 'error');
                    return false;
                }
                
                const responseCedula = await fetch(
                    `${SUPABASE_URL}/rest/v1/usuarios_estudiantes?cedula=eq.${encodeURIComponent(cedula)}&select=cedula`,
                    {
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}` 
                        }
                    }
                );
                const cedulaData = await responseCedula.json();
                
                if (cedulaData && cedulaData.length > 0) {
                    showNotification('La c√©dula ya est√° registrada', 'error');
                    return false;
                }
                
                const nuevoUsuario = { nombre, email, cedula, curso: cursoCompleto, password };
                const { data, error } = await supabase
                    .from('usuarios_estudiantes')
                    .insert([nuevoUsuario]);
                
                if (error) {
                    const usuarios = JSON.parse(localStorage.getItem('usuarios_estudiantes') || '[]');
                    
                    if (usuarios.find(u => u.email === email)) {
                        showNotification('El correo ya est√° registrado', 'error');
                        return false;
                    }
                    if (usuarios.find(u => u.cedula === cedula)) {
                        showNotification('La c√©dula ya est√° registrada', 'error');
                        return false;
                    }
                    
                    usuarios.push(nuevoUsuario);
                    localStorage.setItem('usuarios_estudiantes', JSON.stringify(usuarios));
                    showNotification('‚ö†Ô∏è Registrado localmente (sin conexi√≥n a BD)', 'warning');
                } else {
                    showNotification(`¬°Registro exitoso! Bienvenido/a ${nombre}`, 'success');
                }
                
                state.usuarioActual = nuevoUsuario;
                state.tipoUsuario = 'estudiante';
                state.vista = 'estudiante';
                localStorage.setItem('sesion', JSON.stringify({ tipo: 'estudiante', usuario: nuevoUsuario }));
                
                await cargarDatos();
                render();
                return true;
            } catch (err) {
                console.error('‚ùå Error en registrarEstudiante:', err);
                showNotification('Error: ' + err.message, 'error');
                return false;
            }
        }

        function loginDECE(email, password) {
            if (email === DECE_CREDENTIALS.email && password === DECE_CREDENTIALS.password) {
                state.tipoUsuario = 'dece';
                state.vista = 'dece';
                localStorage.setItem('sesion', JSON.stringify({ tipo: 'dece' }));
                
                cargarDatos().then(() => {
                    render();
                    showNotification('Sesi√≥n DECE iniciada correctamente', 'success');
                });
                return true;
            }
            return false;
        }


        
        async function loginProfesor(email) {
            if (!email.endsWith('@uepdc.edu.ec') || email.endsWith('@est.uepdc.edu.ec')) {
                showNotification('Debes usar tu correo institucional de profesor (@uepdc.edu.ec)', 'error');
                return false;
            }
            
            const nombreEmail = email.split('@')[0].replace(/\./g, ' ');
            const nombre = nombreEmail.split(' ').map(p => 
                p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()
            ).join(' ');
            
            state.usuarioActual = { email, nombre };
            state.tipoUsuario = 'profesor';
            state.vista = 'profesor';
            localStorage.setItem('sesion', JSON.stringify({ tipo: 'profesor', usuario: { email, nombre } }));
            
            await cargarDatos();
            render();
            showNotification(`¬°Bienvenido/a Profesor/a ${nombre}!`, 'success');
            return true;
        }

        function cerrarSesion() {
            state.usuarioActual = null;
            state.tipoUsuario = null;
            state.vista = 'login';
            state.miTurno = null;
            state.historialEstudiante = [];
            localStorage.removeItem('sesion');
            localStorage.removeItem('miTurnoId');
            render();
            showNotification('Sesi√≥n cerrada', 'info');
        }

        // GESTI√ìN DE TURNOS
        async function registrarTurno(form) {
            if (!state.estadoDECE.disponible) {
                showNotification('El DECE no est√° disponible en este momento', 'warning');
                return false;
            }
            
            try {
                const emailEstudiante = state.usuarioActual?.email;
                
                if (!emailEstudiante || emailEstudiante.trim() === '') {
                    showNotification('Error: No se pudo obtener tu email', 'error');
                    return false;
                }
                
                const nuevoTurno = {
                    nombre: form.nombre,
                    cedula: form.cedula,
                    curso: form.curso,
                    motivo: form.motivo,
                    situacion: form.situacion || '',
                    estado: 'pendiente',
                    numero_turno: state.turnos.length + 1,
                    email_estudiante: emailEstudiante.trim()
                };
                
                const { data, error } = await supabase.from('turnos').insert([nuevoTurno]);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const turnoGuardado = data[0];
                    localStorage.setItem('miTurnoId', turnoGuardado.id);
                    await cargarDatos();
                    
                    const turnoCreado = state.turnos.find(t => t.id === turnoGuardado.id);
                    if (turnoCreado) state.miTurno = turnoCreado;
                    
                    showNotification('¬°Turno registrado exitosamente! üéâ', 'success');
                    render();
                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al registrar el turno: ' + error.message, 'error');
                return false;
            }
        }


        
        async function registrarTurnoProfesor(turnoData) {
            if (!state.estadoDECE.disponible) {
                showNotification('El DECE no est√° disponible en este momento', 'warning');
                return false;
            }
            
            try {
                const nuevoTurno = {
                    nombre: turnoData.nombre,
                    cedula: turnoData.cedula,
                    curso: turnoData.curso,
                    motivo: turnoData.motivo,
                    situacion: turnoData.situacion,
                    estado: 'pendiente',
                    numero_turno: state.turnos.length + 1,
                    email_estudiante: turnoData.email_estudiante,
                    solicitado_por: turnoData.solicitado_por,
                    email_profesor: turnoData.email_profesor,
                    nombre_profesor: turnoData.nombre_profesor
                };
                
                const { data, error } = await supabase.from('turnos').insert([nuevoTurno]);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    await cargarDatos();
                    showNotification(`¬°Turno registrado exitosamente para ${turnoData.nombre}! üéâ`, 'success');
                    
                    document.getElementById('formTurnoProfesor').reset();
                    document.getElementById('estudianteSelect').disabled = true;
                    document.getElementById('estudianteInfo').classList.add('hidden');
                    
                    render();
                    return true;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al registrar el turno: ' + error.message, 'error');
                return false;
            }
        }

        async function cambiarDisponibilidad() {
            try {
                const nuevoEstado = !state.estadoDECE.disponible;
                
                const { error } = await supabase.from('configuracion')
                    .update({ disponible: nuevoEstado })
                    .eq('id', state.estadoDECE.id);
                    
                if (error) throw error;
                
                state.estadoDECE.disponible = nuevoEstado;
                showNotification(nuevoEstado ? 'Sistema activado ‚úÖ' : 'Sistema pausado ‚è∏Ô∏è', 'info');
                
                render();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // ========== FUNCI√ìN ACTUALIZADA: ENV√çA EMAIL DE RECHAZO ==========
        async function actualizarEstadoTurno(turnoId, nuevoEstado, motivoRechazo = null, horaProgramada = null, notaDECE = null) {
            try {
                const actualizado = { estado: nuevoEstado };
                if (motivoRechazo) actualizado.motivo_rechazo = motivoRechazo;
                if (horaProgramada) actualizado.hora_atencion_programada = horaProgramada;
                if (notaDECE) actualizado.nota_dece = notaDECE;
                if (nuevoEstado === 'atendido' || nuevoEstado === 'no_asistio') {
                    actualizado.hora_atencion = new Date().toISOString();
                }
                
                const { error } = await supabase.from('turnos').update(actualizado).eq('id', turnoId);
                if (error) throw error;
                
                const mensajes = {
                    'aceptado': '‚úÖ Turno aceptado correctamente',
                    'rechazado': '‚ùå Turno rechazado',
                    'atendido': '‚úîÔ∏è Turno marcado como atendido',
                    'no_asistio': 'üö´ Marcado como "No asisti√≥"'
                };
                
                showNotification(mensajes[nuevoEstado] || 'Turno actualizado', 'success');
                
                // Obtener turno antes de recargar
                const turnoAntes = state.turnos.find(t => t.id === turnoId);
                
                await cargarDatos();
                
                // Enviar emails seg√∫n el estado
                if (nuevoEstado === 'aceptado') {
                    const turnoActualizado = state.turnos.find(t => t.id === turnoId);
                    if (turnoActualizado) {
                        enviarEmailAceptacion(turnoActualizado).catch(err => {
                            console.warn('Email no enviado pero turno aceptado:', err);
                        });
                    }
                }
                
                // ========== ENVIAR EMAIL DE RECHAZO ==========
                if (nuevoEstado === 'rechazado' && turnoAntes) {
                    enviarEmailRechazo(turnoAntes, motivoRechazo).catch(err => {
                        console.warn('Email de rechazo no enviado:', err);
                    });
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function agregarNotaDECE(turnoId) {
            const nota = prompt('Agregar nota interna del DECE:');
            if (!nota) return;
            
            try {
                const { error } = await supabase.from('turnos').update({ nota_dece: nota }).eq('id', turnoId);
                if (error) throw error;
                await cargarDatos();
                showNotification('Nota agregada correctamente', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // RENDERIZADO
        function renderLogin() {
            return `
                <div class="flex items-center justify-center min-h-screen p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full relative overflow-hidden border-4 border-yellow-400">
                        <div class="absolute top-0 left-0 w-full h-3" style="background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);"></div>
                        
                        <div class="text-center mb-8">
                            <div class="flex justify-center mb-6">
                                <img src="https://i.ibb.co/wNhQpyX0/image-30.png" alt="UEPDC Logo" class="logo-institucional">
                            </div>
                            
                            <h1 class="text-4xl font-black mb-3" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                Sistema de Turnos DECE
                            </h1>
                            <p class="text-gray-700 text-lg font-semibold">Departamento de Consejer√≠a Estudiantil</p>
                            <div class="mt-4 inline-block px-5 py-2 rounded-full text-sm font-bold" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1e3a8a;">
                                üè´ UEPDC
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="grid grid-cols-3 gap-2 mb-6">
                                <button id="btnEstudiante" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                                    <span>üë®‚Äçüéì Estudiante</span>
                                </button>
                                <button id="btnProfesor" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                    <span>üë®‚Äçüè´ Profesor</span>
                                </button>
                                <button id="btnDECE" class="py-4 px-4 text-white rounded-xl font-bold text-sm hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                                    <span>üë®‚Äç‚öïÔ∏è DECE</span>
                                </button>
                            </div>
                        </div>

                        <div id="formContainer"></div>
                    </div>
                </div>
            `;
        }

        function renderFormEstudiante() {
            return `
                <div class="space-y-4 fade-in">
                    <div class="flex gap-2 border-b-2 pb-3" style="border-color: #60a5fa;">
                        <button id="btnLoginEst" class="flex-1 py-3 border-b-4 font-bold text-lg transition-all" style="border-color: #1e3a8a; color: #1e3a8a;">
                            Iniciar Sesi√≥n
                        </button>
                        <button id="btnRegistroEst" class="flex-1 py-3 text-gray-500 font-bold text-lg transition-all">
                            Registrarse
                        </button>
                    </div>
                    <div id="formEstudiante"></div>
                </div>
            `;
        }

        function renderLoginEstudiante() {
            return `
                <form id="loginEstForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìß Correo Institucional *</label>
                        <input type="email" name="email" required pattern=".+@est\.uepdc\.edu\.ec$" class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="nombre@est.uepdc.edu.ec">
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üîí Contrase√±a *</label>
                        <input type="password" name="password" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                        <span>üöÄ Iniciar Sesi√≥n</span>
                    </button>
                </form>
            `;
        }

        function renderRegistroEstudiante() {
            return `
                <form id="registroEstForm" class="space-y-4 fade-in max-h-[70vh] overflow-y-auto pr-2">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üë§ Nombre Completo *</label>
                        <input type="text" name="nombre" required minlength="5" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="Ej: Juan Andr√©s P√©rez G√≥mez">
                    </div>
                    
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìß Correo Institucional *</label>
                        <input type="email" name="email" required pattern=".+@est\.uepdc\.edu\.ec$" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="nombre@est.uepdc.edu.ec">
                    </div>
                    
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üÜî C√©dula *</label>
                        <input type="text" name="cedula" required pattern="[0-9]{10}" maxlength="10" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="0123456789">
                    </div>
                    
                    <div class="border-t-2 border-gray-200 pt-4">
                        <h3 class="font-black text-lg mb-3" style="color: #1e3a8a;">üìö Informaci√≥n Acad√©mica</h3>
                        
                        <div class="mb-4">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üéì Nivel Educativo *</label>
                            <select name="nivel" id="nivelSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Selecciona tu nivel</option>
                                <option value="Inicial">üë∂ Inicial</option>
                                <option value="Escuela">üìñ Escuela (1ro - 7mo EGB)</option>
                                <option value="B√°sica Superior">üìö B√°sica Superior (8vo - 10mo EGB)</option>
                                <option value="Bachillerato">üéì Bachillerato (1ro - 3ro BGU)</option>
                            </select>
                        </div>
                        
                        <div id="gradoContainer" class="mb-4" style="display: none;">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìù Curso *</label>
                            <select name="grado" id="gradoSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Primero selecciona el nivel</option>
                            </select>
                        </div>
                        
                        <div id="paraleloContainer" class="mb-4" style="display: none;">
                            <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">üìã Paralelo *</label>
                            <select name="paralelo" id="paraleloSelect" required class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none select-modern" style="border-color: #60a5fa;">
                                <option value="">Primero selecciona el curso</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="border-t-2 border-gray-200 pt-4">
                        <h3 class="font-black text-lg mb-3" style="color: #1e3a8a;">üîí Seguridad</h3>
                        <label class="block font-bold mb-2 text-sm" style="color: #1e3a8a;">Contrase√±a *</label>
                        <input type="password" name="password" required minlength="6" class="w-full px-5 py-3 border-2 rounded-xl focus:outline-none" style="border-color: #60a5fa;" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern sticky bottom-0" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                        <span>‚ú® Crear Cuenta</span>
                    </button>
                </form>
            `;
        }

        // ========== FORMULARIO DECE - SIN CUADRO DE CREDENCIALES ==========
        function renderFormDECE() {
            return `
                <form id="loginDECEForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #92400e;">üìß Correo</label>
                        <input type="email" name="email" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #fbbf24;" placeholder="correo@uepdc.edu.ec">
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #92400e;">üîí Contrase√±a</label>
                        <input type="password" name="password" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #fbbf24;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                        <span>üöÄ Acceder</span>
                    </button>
                    <button type="button" id="btnVolverLogin" class="w-full py-3 rounded-xl font-bold transition-all" style="background: #e5e7eb; color: #374151;">
                        ‚Üê Volver
                    </button>
                </form>
            `;
        }


        // ========== FORMULARIO PROFESOR - SIN CUADRO DE INFORMACI√ìN ==========
        function renderFormProfesor() {
            return `
                <form id="loginProfesorForm" class="space-y-5 fade-in">
                    <div>
                        <label class="block font-bold mb-2 text-sm" style="color: #065f46;">üìß Correo Institucional</label>
                        <input type="email" name="email" required pattern=".+@uepdc\\.edu\\.ec$" class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #34d399;" placeholder="profesor@uepdc.edu.ec">
                        <p class="text-xs mt-2" style="color: #065f46;">‚ö†Ô∏è Solo correos @uepdc.edu.ec (NO @est.uepdc.edu.ec)</p>
                    </div>
                    <button type="submit" class="w-full text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition-all btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        <span>üöÄ Acceder al Panel de Profesores</span>
                    </button>
                    <button type="button" id="btnVolverLoginProf" class="w-full py-3 rounded-xl font-bold transition-all" style="background: #e5e7eb; color: #374151;">
                        ‚Üê Volver
                    </button>
                </form>
            `;
        }

        function renderEstudiante() {
            const tieneTurnoActivo = state.historialEstudiante.some(t => 
                t.estado === 'pendiente' || t.estado === 'aceptado'
            );
            
            return `
                <div class="p-4 fade-in">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 slide-in-left">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-lg" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);">
                                        üë®‚Äçüéì
                                    </div>
                                    <div>
                                        <h1 class="text-3xl font-bold" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            Panel Estudiante
                                        </h1>
                                        <p class="text-gray-600 text-lg"><span class="font-bold" style="color: #1e40af;">${state.usuarioActual.nombre}</span> ‚Ä¢ ${state.usuarioActual.curso}</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    ${state.historialEstudiante.length > 0 ? `
                                        <button onclick="abrirHistorial()" class="bg-purple-500 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:bg-purple-600 transition-all btn-modern font-bold">
                                            <span>üìö Mi Historial</span>
                                        </button>
                                    ` : ''}
                                    ${tieneTurnoActivo && !state.miTurno ? `
                                        <button onclick="verMiTurno()" class="gradient-bg text-white px-6 py-3 rounded-xl hover:shadow-xl transition-all btn-modern font-bold">
                                            <span>üé´ Ver mi turno</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:bg-red-600 transition-all btn-modern font-bold">
                                        <span>üö™ Salir</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="miTurnoContainer">
                            ${state.miTurno ? renderMiTurnoContent() : renderSolicitudTurno()}
                        </div>
                        
                        ${state.mostrarHistorial ? renderModalHistorial() : ''}
                    </div>
                </div>
            `;
        }

        function renderSolicitudTurno() {
            return `
                <div class="bg-white rounded-3xl shadow-2xl p-8 mb-6 slide-in-right">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <span class="text-4xl">üì°</span> Estado del DECE
                    </h2>
                    <div id="estadoDECE">
                        <div class="${state.estadoDECE.disponible ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} p-10 rounded-2xl text-center text-white shadow-xl">
                            <div class="text-7xl mb-4">${state.estadoDECE.disponible ? '‚úÖ' : '‚ùå'}</div>
                            <div class="text-4xl font-black mb-3">
                                ${state.estadoDECE.disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                            </div>
                            <p class="text-xl opacity-90">${state.estadoDECE.disponible ? '¬°Puedes solicitar un turno ahora!' : 'El DECE no est√° recibiendo solicitudes'}</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-2xl p-8 scale-in">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <span class="text-4xl">üìù</span> Solicitar Turno
                    </h2>
                    <form id="formTurno" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üë§ Nombre</label>
                                <input type="text" name="nombre" value="${state.usuarioActual.nombre}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üÜî C√©dula</label>
                                <input type="text" name="cedula" value="${state.usuarioActual.cedula}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üìö Curso</label>
                                <input type="text" name="curso" value="${state.usuarioActual.curso}" readonly class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl bg-gray-50 text-lg">
                            </div>
                            <div>
                                <label class="block font-bold text-gray-700 mb-2">üìã Motivo *</label>
                                <select name="motivo" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #60a5fa;">
                                    <option value="">Seleccione un motivo</option>
                                    <option value="Apoyo Acad√©mico">üìñ Apoyo Acad√©mico</option>
                                    <option value="Orientaci√≥n Personal">üí≠ Orientaci√≥n Personal</option>
                                    <option value="Dificultades Familiares">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dificultades Familiares</option>
                                    <option value="Problemas de Comportamiento">‚ö†Ô∏è Problemas de Comportamiento</option>
                                    <option value="Orientaci√≥n Vocacional">üéØ Orientaci√≥n Vocacional</option>
                                    <option value="Situaci√≥n de Riesgo">üö® Situaci√≥n de Riesgo</option>
                                    <option value="Problemas de Salud Mental">üß† Problemas de Salud Mental</option>
                                    <option value="Acoso Escolar (Bullying)">üõ°Ô∏è Acoso Escolar</option>
                                    <option value="Otros">üìù Otros</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block font-bold text-gray-700 mb-2">üí¨ Describe tu situaci√≥n *</label>
                            <textarea name="situacion" rows="4" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #60a5fa;" placeholder="Por favor describe tu situaci√≥n con detalle..."></textarea>
                        </div>
                        <button type="submit" ${!state.estadoDECE.disponible ? 'disabled' : ''} class="w-full gradient-bg text-white py-5 rounded-xl font-black text-xl hover:shadow-2xl transition-all disabled:bg-gray-400 disabled:cursor-not-allowed btn-modern">
                            <span>‚ú® Solicitar Turno</span>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderMiTurnoContent() {
            const turno = state.miTurno;
            
            let estaEnProceso = false;
            if (turno.hora_atencion_programada) {
                const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                if (horaInicio) {
                    estaEnProceso = HoraUtils.citaEnProceso(horaInicio);
                }
            }
            
            const turnosEnCola = state.turnos.filter(t => 
                (t.estado === 'pendiente' || t.estado === 'aceptado')
            ).sort((a, b) => a.numero_turno - b.numero_turno);
            
            const miPosicion = turnosEnCola.findIndex(t => t.id === turno.id) + 1;
            const totalEnCola = turnosEnCola.length;
            
            return `
                ${(turno.estado === 'pendiente' || turno.estado === 'aceptado') ? `
                    <div class="gradient-bg text-white rounded-2xl p-10 text-center mb-6 shadow-2xl">
                        <div class="text-xl mb-3 font-semibold">üìä Tu posici√≥n en la fila</div>
                        <div class="text-8xl font-black my-6">#${miPosicion}</div>
                        <div class="text-2xl mb-4 font-bold">de ${totalEnCola} persona${totalEnCola !== 1 ? 's' : ''} esperando</div>
                        <div class="border-t-2 border-white/30 pt-6 mt-6 space-y-2">
                            <div class="text-lg">üìÖ ${new Date(turno.created_at).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <div class="text-lg">‚è∞ ${new Date(turno.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                            <div class="text-lg mt-4">üë§ ${turno.nombre}</div>
                            <div class="text-lg">üìö ${turno.curso}</div>
                            <div class="text-lg mt-2">üìã ${turno.motivo}</div>
                        </div>
                    </div>
                ` : `
                    <div class="gradient-bg text-white rounded-2xl p-10 text-center mb-6 shadow-2xl">
                        <div class="text-xl mb-3 font-semibold">Tu n√∫mero de turno</div>
                        <div class="text-8xl font-black my-6">#${turno.numero_turno}</div>
                        <div class="text-xl">üìÖ ${new Date(turno.created_at).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <div class="text-xl mt-2">‚è∞ ${new Date(turno.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="border-t-2 border-white/30 pt-6 mt-6 space-y-2">
                            <div class="text-xl">üë§ ${turno.nombre}</div>
                            <div class="text-xl">üìö ${turno.curso}</div>
                            <div class="text-xl mt-2">üìã ${turno.motivo}</div>
                        </div>
                    </div>
                `}
                
                ${estaEnProceso ? `
                    <div class="badge-en-proceso text-white p-8 rounded-2xl mb-6 text-center shadow-xl">
                        <div class="text-5xl mb-3">üîÑ</div>
                        <div class="text-3xl font-black">EN PROCESO</div>
                        <div class="text-lg mt-2">Tu cita est√° en curso: ${turno.hora_atencion_programada}</div>
                    </div>
                ` : ''}
                
                <div class="bg-white rounded-2xl p-8 shadow-xl mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã Estado de tu turno</h3>
                    ${renderEstadoTurno(turno)}
                </div>
                
                <button onclick="volverInicio()" class="w-full bg-gray-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-600 transition-all btn-modern">
                    <span>‚Üê Volver al inicio</span>
                </button>
            `;
        }

        function renderEstadoTurno(turno) {
            const estados = {
                'pendiente': { color: 'yellow', icon: '‚è≥', texto: 'Pendiente de revisi√≥n' },
                'aceptado': { color: 'green', icon: '‚úÖ', texto: 'Aceptado' },
                'rechazado': { color: 'red', icon: '‚ùå', texto: 'Rechazado' },
                'atendido': { color: 'blue', icon: '‚úîÔ∏è', texto: 'Atendido' },
                'no_asistio': { color: 'gray', icon: 'üö´', texto: 'No asisti√≥' }
            };
            
            const estado = estados[turno.estado] || estados.pendiente;
            
            return `
                <div class="bg-${estado.color}-100 border-2 border-${estado.color}-300 rounded-xl p-6">
                    <div class="flex items-center gap-4">
                        <span class="text-5xl">${estado.icon}</span>
                        <div>
                            <div class="text-2xl font-bold text-${estado.color}-700">${estado.texto}</div>
                            ${turno.hora_atencion_programada ? `
                                <div class="text-lg text-${estado.color}-600 mt-1">üïê Hora programada: ${turno.hora_atencion_programada}</div>
                            ` : ''}
                            ${turno.motivo_rechazo ? `
                                <div class="text-lg text-red-600 mt-2">üìù Motivo: ${turno.motivo_rechazo}</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }


        function renderProfesor() {
            const cursosDisponibles = ordenarCursosCorrectamente(Object.keys(ESTUDIANTES_BD));
            
            return `
                <div class="p-4 fade-in">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 slide-in-left">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-lg" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                        üë®‚Äçüè´
                                    </div>
                                    <div>
                                        <h1 class="text-3xl font-bold" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            Panel Profesor
                                        </h1>
                                        <p class="text-gray-600 text-lg"><span class="font-bold" style="color: #059669;">${state.usuarioActual.nombre}</span></p>
                                    </div>
                                </div>
                                <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:bg-red-600 transition-all btn-modern font-bold">
                                    <span>üö™ Salir</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-2xl p-8 mb-6 slide-in-right">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                                <span class="text-4xl">üì°</span> Estado del DECE
                            </h2>
                            <div class="${state.estadoDECE.disponible ? 'bg-gradient-to-r from-green-400 to-green-500' : 'bg-gradient-to-r from-red-400 to-red-500'} p-8 rounded-2xl text-center text-white shadow-xl">
                                <div class="text-6xl mb-3">${state.estadoDECE.disponible ? '‚úÖ' : '‚ùå'}</div>
                                <div class="text-3xl font-black mb-2">
                                    ${state.estadoDECE.disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                                </div>
                                <p class="text-lg opacity-90">${state.estadoDECE.disponible ? '¬°Puede solicitar turnos para estudiantes!' : 'El DECE no est√° recibiendo solicitudes'}</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-2xl p-8 scale-in">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                                <span class="text-4xl">üìù</span> Solicitar Turno para Estudiante
                            </h2>
                            <form id="formTurnoProfesor" class="space-y-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block font-bold text-gray-700 mb-2">üìö Seleccionar Curso *</label>
                                        <select id="cursoSelect" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #34d399;">
                                            <option value="">Seleccione un curso</option>
                                            ${cursosDisponibles.map(curso => `
                                                <option value="${curso}">${curso}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block font-bold text-gray-700 mb-2">üë§ Seleccionar Estudiante *</label>
                                        <select id="estudianteSelect" required disabled class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #34d399;">
                                            <option value="">Primero seleccione un curso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="estudianteInfo" class="hidden bg-green-50 border-2 border-green-200 rounded-xl p-4">
                                    <h4 class="font-bold text-green-800 mb-2">üìã Informaci√≥n del Estudiante</h4>
                                    <div class="grid md:grid-cols-3 gap-4 text-sm">
                                        <div><span class="font-semibold">Nombre:</span> <span id="infoNombre"></span></div>
                                        <div><span class="font-semibold">Email:</span> <span id="infoEmail"></span></div>
                                        <div><span class="font-semibold">Curso:</span> <span id="infoCurso"></span></div>
                                    </div>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block font-bold text-gray-700 mb-2">üìã Motivo *</label>
                                        <select name="motivo" required class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:outline-none text-lg select-modern" style="border-color: #34d399;">
                                            <option value="">Seleccione un motivo</option>
                                            <option value="Apoyo Acad√©mico">üìñ Apoyo Acad√©mico</option>
                                            <option value="Orientaci√≥n Personal">üí≠ Orientaci√≥n Personal</option>
                                            <option value="Dificultades Familiares">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dificultades Familiares</option>
                                            <option value="Problemas de Comportamiento">‚ö†Ô∏è Problemas de Comportamiento</option>
                                            <option value="Orientaci√≥n Vocacional">üéØ Orientaci√≥n Vocacional</option>
                                            <option value="Situaci√≥n de Riesgo">üö® Situaci√≥n de Riesgo</option>
                                            <option value="Problemas de Salud Mental">üß† Problemas de Salud Mental</option>
                                            <option value="Acoso Escolar (Bullying)">üõ°Ô∏è Acoso Escolar</option>
                                            <option value="Otros">üìù Otros</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block font-bold text-gray-700 mb-2">üí¨ Describe la situaci√≥n del estudiante *</label>
                                    <textarea name="situacion" rows="4" required class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none text-lg" style="border-color: #34d399;" placeholder="Por favor describe la situaci√≥n del estudiante con detalle..."></textarea>
                                </div>
                                <button type="submit" ${!state.estadoDECE.disponible ? 'disabled' : ''} class="w-full text-white py-5 rounded-xl font-black text-xl hover:shadow-2xl transition-all disabled:bg-gray-400 disabled:cursor-not-allowed btn-modern" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                    <span>‚ú® Solicitar Turno para Estudiante</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModalHistorial() {
            const coloresHistorial = {
                'atendido': 'bg-green-50 border-green-300',
                'rechazado': 'bg-red-50 border-red-300',
                'no_asistio': 'bg-orange-50 border-orange-300',
                'pendiente': 'bg-yellow-50 border-yellow-300',
                'aceptado': 'bg-blue-50 border-blue-300'
            };
            
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="cerrarHistorial()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b-2 border-gray-200 p-6 rounded-t-3xl z-10">
                            <div class="flex justify-between items-center">
                                <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                    <span class="text-4xl">üìö</span> Mi Historial
                                </h2>
                                <button onclick="cerrarHistorial()" class="text-gray-500 hover:text-gray-700 text-4xl font-bold">
                                    √ó
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            ${state.historialEstudiante.length > 0 ? state.historialEstudiante.map(turno => `
                                <div class="border-2 ${coloresHistorial[turno.estado] || 'bg-gray-50 border-gray-300'} rounded-2xl p-6 shadow-lg">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-2xl font-bold text-gray-800">Turno #${turno.numero_turno}</h3>
                                            <p class="text-gray-600 mt-1">${new Date(turno.created_at).toLocaleDateString('es-ES')}</p>
                                        </div>
                                        <span class="text-3xl">
                                            ${turno.estado === 'atendido' ? '‚úÖ' : turno.estado === 'rechazado' ? '‚ùå' : turno.estado === 'no_asistio' ? 'üö´' : turno.estado === 'aceptado' ? '‚úîÔ∏è' : '‚è≥'}
                                        </span>
                                    </div>
                                    <div class="space-y-2 text-gray-700">
                                        <p><strong>üìã Motivo:</strong> ${turno.motivo}</p>
                                        <p><strong>üìä Estado:</strong> ${turno.estado === 'atendido' ? 'Atendido' : turno.estado === 'rechazado' ? 'Rechazado' : turno.estado === 'no_asistio' ? 'No Asisti√≥' : turno.estado === 'aceptado' ? 'Aceptado' : 'Pendiente'}</p>
                                        ${turno.hora_atencion_programada ? `<p><strong>üïê Hora:</strong> ${turno.hora_atencion_programada}</p>` : ''}
                                        ${turno.motivo_rechazo ? `<p class="text-red-600"><strong>‚ùå Motivo de rechazo:</strong> ${turno.motivo_rechazo}</p>` : ''}
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="text-center py-16">
                                    <div class="text-8xl mb-6">üì≠</div>
                                    <h3 class="text-3xl font-bold text-gray-700 mb-3">Sin historial</h3>
                                    <p class="text-gray-500 text-lg">A√∫n no has solicitado ning√∫n turno</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSinTurnos() {
            return `
                <div class="text-center py-16">
                    <div class="text-8xl mb-6">üì≠</div>
                    <h3 class="text-3xl font-bold text-gray-700 mb-3">No hay turnos</h3>
                    <p class="text-gray-500 text-lg">No se encontraron turnos con los filtros actuales</p>
                </div>
            `;
        }

        function renderTurnoCard(turno) {
            let estaEnProceso = false;
            if (turno.estado === 'aceptado' && turno.hora_atencion_programada) {
                const horaInicio = HoraUtils.extraerHoraInicio(turno.hora_atencion_programada);
                if (horaInicio) {
                    estaEnProceso = HoraUtils.citaEnProceso(horaInicio);
                }
            }
            
            const coloresEstado = {
                'pendiente': 'bg-yellow-200 border-yellow-500',
                'aceptado': estaEnProceso ? 'bg-orange-200 border-orange-500' : 'bg-green-200 border-green-500',
                'rechazado': 'bg-red-200 border-red-500',
                'atendido': 'bg-blue-200 border-blue-500',
                'no_asistio': 'bg-purple-200 border-purple-500'
            };
            
            const iconosEstado = {
                'pendiente': '‚è≥',
                'aceptado': estaEnProceso ? 'üîÑ' : '‚úÖ',
                'rechazado': '‚ùå',
                'atendido': '‚úîÔ∏è',
                'no_asistio': 'üö´'
            };
            
            const esSolicitadoPorProfesor = turno.solicitado_por === 'profesor';
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 border-l-4 ${coloresEstado[turno.estado]} card-hover">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${iconosEstado[turno.estado]}</span>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${turno.nombre}</h3>
                                <p class="text-sm text-gray-600">${turno.curso}</p>
                                ${esSolicitadoPorProfesor ? `
                                    <p class="text-xs text-purple-600 font-semibold mt-1">üë®‚Äçüè´ Solicitado por: ${turno.nombre_profesor || 'Profesor'}</p>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">#${turno.numero_turno}</div>
                            <div class="text-xs text-gray-400">${new Date(turno.created_at).toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div><span class="font-semibold">üìã Motivo:</span> ${turno.motivo}</div>
                        <div><span class="font-semibold">üìß Email:</span> ${turno.email_estudiante || 'N/A'}</div>
                        ${turno.hora_atencion_programada ? `
                            <div class="col-span-2">
                                <span class="font-semibold">üïê Hora:</span> ${turno.hora_atencion_programada}
                                ${turno.estado !== 'atendido' ? `
                                    <button onclick="editarHora(${turno.id}, '${turno.hora_atencion_programada}')" class="text-blue-500 hover:text-blue-700 ml-2">‚úèÔ∏è</button>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${turno.motivo_rechazo ? `
                            <div class="col-span-2 text-red-600"><span class="font-semibold">‚ùå Rechazo:</span> ${turno.motivo_rechazo}</div>
                        ` : ''}
                        ${turno.nota_dece ? `
                            <div class="col-span-2 text-purple-600"><span class="font-semibold">üìù Nota DECE:</span> ${turno.nota_dece}</div>
                        ` : ''}
                    </div>
                    
                    ${turno.situacion ? `
                        <div class="bg-gray-50 p-2 rounded-lg mb-3 text-sm">
                            <span class="font-semibold text-gray-700">üí¨ Situaci√≥n:</span>
                            <p class="text-gray-600 mt-1">${turno.situacion}</p>
                        </div>
                    ` : ''}
                    
                    ${estaEnProceso ? `
                        <div class="badge-en-proceso text-white px-3 py-2 rounded-lg text-center mb-3 font-bold text-sm">
                            üîÑ CITA EN PROCESO
                        </div>
                    ` : ''}
                    
                    <div class="flex flex-wrap gap-2">
                        ${turno.estado === 'pendiente' ? `
                            <button onclick="aceptarTurnoConHora(${turno.id})" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-all font-semibold text-sm">
                                Aceptar
                            </button>
                            <button onclick="rechazarTurno(${turno.id})" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-all font-semibold text-sm">
                                Rechazar
                            </button>
                        ` : ''}
                        ${turno.estado === 'aceptado' ? `
                            <button onclick="marcarAtendido(${turno.id})" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-all font-semibold text-sm">
                                Atendido
                            </button>
                            <button onclick="marcarNoAsistio(${turno.id})" class="bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 transition-all font-semibold text-sm">
                                No asisti√≥
                            </button>
                        ` : ''}
                        <button onclick="agregarNotaDECE(${turno.id})" class="bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 transition-all font-semibold text-sm">
                            Nota
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDECE() {
            return `
                <div class="p-4 fade-in">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6 slide-in-left">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                                        üéì
                                    </div>
                                    <div>
                                        <h1 class="text-3xl font-bold" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            Panel DECE
                                        </h1>
                                        <p class="text-gray-600 text-lg">Departamento de Consejer√≠a Estudiantil</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="refrescarManual()" class="bg-blue-500 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:bg-blue-600 transition-all btn-modern font-bold">
                                        <span>üîÑ Actualizar</span>
                                    </button>
                                    <button onclick="cerrarSesion()" class="bg-red-500 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:bg-red-600 transition-all btn-modern font-bold">
                                        <span>üö™ Salir</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-3 gap-6 mb-6">
                            <div class="lg:col-span-1">
                                <div class="${state.estadoDECE.disponible ? 'bg-gradient-to-br from-green-400 to-green-500' : 'bg-gradient-to-br from-red-400 to-red-500'} control-disponible-card rounded-2xl text-center text-white shadow-xl card-hover">
                                    <div class="control-disponible-icon">${state.estadoDECE.disponible ? '‚úÖ' : '‚ùå'}</div>
                                    <div class="control-disponible-title font-black">
                                        ${state.estadoDECE.disponible ? 'DISPONIBLE' : 'NO DISPONIBLE'}
                                    </div>
                                    <p class="control-disponible-text opacity-90">${state.estadoDECE.disponible ? 'Recibiendo solicitudes' : 'Sistema pausado'}</p>
                                    <button onclick="cambiarDisponibilidad()" class="${state.estadoDECE.disponible ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white control-disponible-btn rounded-xl font-bold transition-all btn-modern">
                                        <span>${state.estadoDECE.disponible ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Activar'}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                                        <div class="control-stats-number font-black">${state.estadisticas.pendientes}</div>
                                        <div class="control-stats-label font-semibold opacity-90">‚è≥ Pendientes</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-green-400 to-green-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                                        <div class="control-stats-number font-black">${state.estadisticas.aceptados}</div>
                                        <div class="control-stats-label font-semibold opacity-90">‚úÖ Aceptados</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-orange-400 to-orange-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                                        <div class="control-stats-number font-black">${state.estadisticas.enProceso}</div>
                                        <div class="control-stats-label font-semibold opacity-90">üîÑ En proceso</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-blue-400 to-blue-500 control-stats-card rounded-xl text-center text-white shadow-lg card-hover">
                                        <div class="control-stats-number font-black">${state.estadisticas.atendidos}</div>
                                        <div class="control-stats-label font-semibold opacity-90">‚úîÔ∏è Atendidos</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-2xl p-6 mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                                <span class="text-3xl">üìä</span> Estad√≠sticas del D√≠a
                            </h2>
                            <div id="estadisticas">
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-5 rounded-2xl text-center border-2 border-gray-300 card-hover">
                                        <div class="text-3xl font-black text-gray-700 mb-1">${state.estadisticas.totalHoy}</div>
                                        <div class="text-xs text-gray-600 font-semibold">üìã Total hoy</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-5 rounded-2xl text-center border-2 border-yellow-300 card-hover">
                                        <div class="text-3xl font-black text-yellow-700 mb-1">${state.turnos.filter(t => t.estado === 'pendiente' && new Date(t.created_at).toLocaleDateString('es-ES') === new Date().toLocaleDateString('es-ES')).length}</div>
                                        <div class="text-xs text-yellow-600 font-semibold">‚è≥ Pendientes</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-2xl text-center border-2 border-orange-300 card-hover">
                                        <div class="text-3xl font-black text-orange-700 mb-1">${state.estadisticas.enProceso}</div>
                                        <div class="text-xs text-orange-600 font-semibold">üîÑ En proceso</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl text-center border-2 border-blue-300 card-hover">
                                        <div class="text-3xl font-black text-blue-700 mb-1">${state.turnos.filter(t => t.estado === 'atendido' && new Date(t.created_at).toLocaleDateString('es-ES') === new Date().toLocaleDateString('es-ES')).length}</div>
                                        <div class="text-xs text-blue-600 font-semibold">‚úîÔ∏è Completados</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-2xl text-center border-2 border-purple-300 card-hover">
                                        <div class="text-3xl font-black text-purple-700 mb-1">${state.estadisticas.no_asistio}</div>
                                        <div class="text-xs text-purple-600 font-semibold">üö´ No asisti√≥</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-2xl p-6">
                            <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <span class="text-3xl">üìã</span> Lista de Turnos
                                </h2>
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="filtrarTurnos('todos')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.filtroTurnos === 'todos' ? 'bg-gray-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                        üìã Todos
                                    </button>
                                    <button onclick="filtrarTurnos('pendiente')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.filtroTurnos === 'pendiente' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}">
                                        ‚è≥ Pendientes
                                    </button>
                                    <button onclick="filtrarTurnos('aceptado')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.filtroTurnos === 'aceptado' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                        ‚úÖ Aceptados
                                    </button>
                                    <button onclick="filtrarTurnos('en_proceso')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.filtroTurnos === 'en_proceso' ? 'bg-orange-500 text-white' : 'bg-orange-100 text-orange-700 hover:bg-orange-200'}">
                                        üîÑ En proceso
                                    </button>
                                    <button onclick="filtrarTurnos('atendido')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.filtroTurnos === 'atendido' ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}">
                                        ‚úîÔ∏è Atendidos
                                    </button>
                                </div>
                            </div>

                            
                            <div id="listaTurnos">
                                ${filtrarYBuscarTurnos().length === 0 
                                    ? renderSinTurnos() 
                                    : `<div class="space-y-4">${filtrarYBuscarTurnos().map(turno => renderTurnoCard(turno)).join('')}</div>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // EVENT HANDLERS
        function attachLoginEvents() {
            const btnEstudiante = document.getElementById('btnEstudiante');
            const btnProfesor = document.getElementById('btnProfesor');
            const btnDECE = document.getElementById('btnDECE');
            const formContainer = document.getElementById('formContainer');
            
            if (btnEstudiante) {
                btnEstudiante.addEventListener('click', () => {
                    formContainer.innerHTML = renderFormEstudiante();
                    attachEstudianteFormEvents();
                });
            }
            
            if (btnProfesor) {
                btnProfesor.addEventListener('click', () => {
                    formContainer.innerHTML = renderFormProfesor();
                    attachProfesorFormEvents();
                });
            }
            
            if (btnDECE) {
                btnDECE.addEventListener('click', () => {
                    formContainer.innerHTML = renderFormDECE();
                    attachDECEFormEvents();
                });
            }
        }

        function attachEstudianteFormEvents() {
            const btnLoginEst = document.getElementById('btnLoginEst');
            const btnRegistroEst = document.getElementById('btnRegistroEst');
            const formEstudiante = document.getElementById('formEstudiante');
            
            if (btnLoginEst && btnRegistroEst && formEstudiante) {
                formEstudiante.innerHTML = renderLoginEstudiante();
                
                btnLoginEst.addEventListener('click', () => {
                    btnLoginEst.classList.add('border-b-4');
                    btnLoginEst.style.borderColor = '#1e3a8a';
                    btnLoginEst.style.color = '#1e3a8a';
                    btnRegistroEst.classList.remove('border-b-4');
                    btnRegistroEst.style.color = '#6b7280';
                    formEstudiante.innerHTML = renderLoginEstudiante();
                    attachLoginEstudianteEvents();
                });
                
                btnRegistroEst.addEventListener('click', () => {
                    btnRegistroEst.classList.add('border-b-4');
                    btnRegistroEst.style.borderColor = '#1e3a8a';
                    btnRegistroEst.style.color = '#1e3a8a';
                    btnLoginEst.classList.remove('border-b-4');
                    btnLoginEst.style.color = '#6b7280';
                    formEstudiante.innerHTML = renderRegistroEstudiante();
                    attachRegistroEstudianteEvents();
                });
                
                attachLoginEstudianteEvents();
            }
        }

        function attachLoginEstudianteEvents() {
            const loginEstForm = document.getElementById('loginEstForm');
            if (loginEstForm) {
                loginEstForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const result = await loginEstudiante(formData.get('email'), formData.get('password'));
                    if (!result) {
                        showNotification('Credenciales incorrectas', 'error');
                    }
                });
            }
        }

        function attachRegistroEstudianteEvents() {
            const registroEstForm = document.getElementById('registroEstForm');
            const nivelSelect = document.getElementById('nivelSelect');
            const gradoSelect = document.getElementById('gradoSelect');
            const paraleloSelect = document.getElementById('paraleloSelect');
            const gradoContainer = document.getElementById('gradoContainer');
            const paraleloContainer = document.getElementById('paraleloContainer');
            
            if (nivelSelect) {
                nivelSelect.addEventListener('change', (e) => {
                    const nivel = e.target.value;
                    if (nivel && CURSOS_PARALELOS[nivel]) {
                        gradoSelect.innerHTML = '<option value="">Selecciona tu curso</option>';
                        CURSOS_PARALELOS[nivel].cursos.forEach(curso => {
                            gradoSelect.innerHTML += `<option value="${curso}">${curso}</option>`;
                        });
                        gradoContainer.style.display = 'block';
                        paraleloContainer.style.display = 'none';
                        paraleloSelect.innerHTML = '<option value="">Primero selecciona el curso</option>';
                    } else {
                        gradoContainer.style.display = 'none';
                        paraleloContainer.style.display = 'none';
                    }
                });
            }
            
            if (gradoSelect) {
                gradoSelect.addEventListener('change', (e) => {
                    const nivel = nivelSelect.value;
                    const grado = e.target.value;
                    if (grado && CURSOS_PARALELOS[nivel]?.paralelos[grado]) {
                        paraleloSelect.innerHTML = '<option value="">Selecciona tu paralelo</option>';
                        CURSOS_PARALELOS[nivel].paralelos[grado].forEach(paralelo => {
                            paraleloSelect.innerHTML += `<option value="${paralelo}">${paralelo}</option>`;
                        });
                        paraleloContainer.style.display = 'block';
                    } else {
                        paraleloContainer.style.display = 'none';
                    }
                });
            }
            
            if (registroEstForm) {
                registroEstForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    await registrarEstudiante({
                        nombre: formData.get('nombre'),
                        email: formData.get('email'),
                        cedula: formData.get('cedula'),
                        nivel: formData.get('nivel'),
                        grado: formData.get('grado'),
                        paralelo: formData.get('paralelo'),
                        password: formData.get('password')
                    });
                });
            }
        }

        function attachProfesorFormEvents() {
            const loginProfesorForm = document.getElementById('loginProfesorForm');
            const btnVolverLoginProf = document.getElementById('btnVolverLoginProf');
            
            if (loginProfesorForm) {
                loginProfesorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const result = await loginProfesor(formData.get('email'));
                    if (!result) {
                        showNotification('Email inv√°lido', 'error');
                    }
                });
            }
            
            if (btnVolverLoginProf) {
                btnVolverLoginProf.addEventListener('click', () => {
                    document.getElementById('formContainer').innerHTML = '';
                });
            }
        }

        function attachDECEFormEvents() {
            const loginDECEForm = document.getElementById('loginDECEForm');
            const btnVolverLogin = document.getElementById('btnVolverLogin');
            
            if (loginDECEForm) {
                loginDECEForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const result = loginDECE(formData.get('email'), formData.get('password'));
                    if (!result) {
                        showNotification('Credenciales DECE incorrectas', 'error');
                    }
                });
            }
            
            if (btnVolverLogin) {
                btnVolverLogin.addEventListener('click', () => {
                    document.getElementById('formContainer').innerHTML = '';
                });
            }
        }

        function attachProfesorEvents() {
            const cursoSelect = document.getElementById('cursoSelect');
            const estudianteSelect = document.getElementById('estudianteSelect');
            const estudianteInfo = document.getElementById('estudianteInfo');
            
            if (cursoSelect) {
                cursoSelect.addEventListener('change', (e) => {
                    const curso = e.target.value;
                    estudianteSelect.innerHTML = '<option value="">Seleccione un estudiante</option>';
                    
                    if (curso && ESTUDIANTES_BD[curso]) {
                        ESTUDIANTES_BD[curso].forEach(estudiante => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(estudiante);
                            option.textContent = estudiante['Nombre completo estudiante'];
                            estudianteSelect.appendChild(option);
                        });
                        estudianteSelect.disabled = false;
                    } else {
                        estudianteSelect.disabled = true;
                    }
                    estudianteInfo.classList.add('hidden');
                });
            }
            
            if (estudianteSelect) {
                estudianteSelect.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const estudiante = JSON.parse(e.target.value);
                        const curso = cursoSelect.value;
                        
                        document.getElementById('infoNombre').textContent = estudiante['Nombre completo estudiante'];
                        document.getElementById('infoEmail').textContent = estudiante['Email estudiante'];
                        document.getElementById('infoCurso').textContent = curso;
                        estudianteInfo.classList.remove('hidden');
                    } else {
                        estudianteInfo.classList.add('hidden');
                    }
                });
            }
            
            const formTurnoProfesor = document.getElementById('formTurnoProfesor');
            if (formTurnoProfesor) {
                formTurnoProfesor.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const estudianteSelect = document.getElementById('estudianteSelect');
                    if (!estudianteSelect.value) {
                        showNotification('Debes seleccionar un estudiante', 'error');
                        return;
                    }
                    
                    const estudiante = JSON.parse(estudianteSelect.value);
                    const curso = document.getElementById('cursoSelect').value;
                    const formData = new FormData(e.target);
                    
                    const turnoData = {
                        nombre: estudiante['Nombre completo estudiante'],
                        email_estudiante: estudiante['Email estudiante'],
                        cedula: 'N/A',
                        curso: curso,
                        motivo: formData.get('motivo'),
                        situacion: formData.get('situacion'),
                        solicitado_por: 'profesor',
                        email_profesor: state.usuarioActual.email,
                        nombre_profesor: state.usuarioActual.nombre
                    };
                    
                    await registrarTurnoProfesor(turnoData);
                });
            }
        }

        function attachEstudianteEvents() {
            const formTurno = document.getElementById('formTurno');
            if (formTurno) {
                formTurno.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    registrarTurno({
                        nombre: formData.get('nombre'),
                        cedula: formData.get('cedula'),
                        curso: formData.get('curso'),
                        motivo: formData.get('motivo'),
                        situacion: formData.get('situacion')
                    });
                });
            }
        }

        // Funciones globales
        window.cerrarSesion = cerrarSesion;
        window.cambiarDisponibilidad = cambiarDisponibilidad;
        window.agregarNotaDECE = agregarNotaDECE;
        
        window.refrescarManual = async () => {
            await cargarDatos();
            if (state.vista === 'dece') {
                render();
            }
            showNotification('Datos actualizados ‚úÖ', 'success');
        };
        
        window.aceptarTurnoConHora = async (id) => {
            const hora = prompt('üïê Hora de inicio (ej: 10:00):');
            if (hora && /^\d{1,2}:\d{2}$/.test(hora)) {
                const rangoCompleto = HoraUtils.generarRango(hora);
                await actualizarEstadoTurno(id, 'aceptado', null, rangoCompleto);
            } else if (hora) {
                showNotification('Formato inv√°lido', 'error');
            }
        };
        
        window.editarHora = async (id, horaActual) => {
            const hora = prompt('Modificar hora de inicio (formato 24h, ej: 10:00):', HoraUtils.extraerHoraInicio(horaActual) || '10:00');
            if (hora && hora !== horaActual && /^\d{1,2}:\d{2}$/.test(hora)) {
                try {
                    const rangoCompleto = HoraUtils.generarRango(hora);
                    
                    const { error } = await supabase.from('turnos').update({ 
                        hora_atencion_programada: rangoCompleto 
                    }).eq('id', id);
                    
                    if (error) throw error;
                    await cargarDatos();
                    showNotification('Hora actualizada con rango de 40 minutos ‚úÖ', 'success');
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                }
            } else if (hora && !/^\d{1,2}:\d{2}$/.test(hora)) {
                showNotification('Formato inv√°lido. Usa HH:MM (ej: 10:00)', 'error');
            }
        };
        
        window.rechazarTurno = (id) => {
            const motivo = prompt('Motivo del rechazo:');
            if (motivo) {
                actualizarEstadoTurno(id, 'rechazado', motivo);
            }
        };
        
        window.marcarAtendido = (id) => {
            if (confirm('¬øConfirmar atendido?')) {
                actualizarEstadoTurno(id, 'atendido');
            }
        };
        
        window.marcarNoAsistio = (id) => {
            if (confirm('¬øConfirmar no asisti√≥?')) {
                actualizarEstadoTurno(id, 'no_asistio');
            }
        };
        
        window.cerrarMiTurno = () => {
            state.miTurno = null;
            render();
        };
        
        window.verMiTurno = async () => {
            const miTurnoId = localStorage.getItem('miTurnoId');
            if (miTurnoId) {
                await cargarDatos();
                const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                if (turno) {
                    state.miTurno = turno;
                    render();
                } else {
                    localStorage.removeItem('miTurnoId');
                    showNotification('Turno no disponible', 'warning');
                    render();
                }
            }
        };
        
        window.volverInicio = () => {
            state.miTurno = null;
            localStorage.removeItem('miTurnoId');
            render();
        };
        
        window.abrirHistorial = () => {
            state.mostrarHistorial = true;
            render();
        };
        
        window.cerrarHistorial = () => {
            state.mostrarHistorial = false;
            render();
        };
        
        window.filtrarTurnos = (filtro) => {
            state.filtroTurnos = filtro;
            actualizarListaTurnosUI();
        };

        // RENDERIZADO PRINCIPAL
        function render() {
            const app = document.getElementById('app');
            
            if (state.vista === 'login') {
                app.innerHTML = renderLogin();
                attachLoginEvents();
            } else if (state.vista === 'estudiante') {
                app.innerHTML = renderEstudiante();
                attachEstudianteEvents();
            } else if (state.vista === 'profesor') {
                app.innerHTML = renderProfesor();
                attachProfesorEvents();
            } else if (state.vista === 'dece') {
                app.innerHTML = renderDECE();
            }
        }

        // VERIFICAR SESI√ìN E INICIALIZACI√ìN
        function verificarSesion() {
            const sesion = localStorage.getItem('sesion');
            if (sesion) {
                const { tipo, usuario } = JSON.parse(sesion);
                state.tipoUsuario = tipo;
                state.vista = tipo;
                state.usuarioActual = usuario;
            }
        }

        // Auto-refresh OPTIMIZADO - 10 segundos
        let refreshInterval;
        
        function iniciarAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            refreshInterval = setInterval(async () => {
                if (state.configurado && (state.vista === 'estudiante' || state.vista === 'dece')) {
                    await cargarDatos();
                }
            }, 10000);
        }

        // ========== INICIALIZACI√ìN OPTIMIZADA ==========
        async function init() {
            console.log('üöÄ Iniciando Sistema DECE...');
            const startTime = performance.now();
            
            // Inicializar EmailJS (as√≠ncrono, no bloquea)
            setTimeout(initEmailJS, 100);
            
            // Cargar datos en paralelo
            const [estudiantesOk] = await Promise.all([
                cargarEstudiantes(),
                verificarConfiguracion()
            ]);
            
            verificarSesion();
            
            if (state.vista !== 'login') {
                await cargarDatos();
                
                if (state.vista === 'estudiante') {
                    const miTurnoId = localStorage.getItem('miTurnoId');
                    if (miTurnoId && state.turnos.length > 0) {
                        const turno = state.turnos.find(t => t.id === parseInt(miTurnoId));
                        if (turno) state.miTurno = turno;
                    }
                    
                    state.historialEstudiante = state.turnos.filter(t => 
                        t.email_estudiante === state.usuarioActual.email
                    );
                }
            }
            
            render();
            iniciarAutoRefresh();
            
            const endTime = performance.now();
            console.log(`‚úÖ Sistema listo en ${(endTime - startTime).toFixed(0)}ms`);
        }

        // Esperar a que el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
